{% load i18n %}
{% load iclock_tags %}
<style type="text/css">
 #calendar {
  font-size: 14px;
  text-align: center;
 }
</style>
<script>
	var jqOptions2={}
	var jqOptions3={}
	var totalRecCnt_emp=0
	var page_tab_user_of_run=""
	var schClass_uor=[];
	var shifts=[];
	var assignedShifts=[];
	var MayUsedAutoIds=[];
	var AutoSchPlan=1;
	var MinAutoPlanInterval=24;
	var weekStartDay=0;
	var cal=''
	var dept_schedule_set={}
	var eventObj={events:'',delta:0,dayDelta:0,minuteDelta:0,eventName:'drop'}
	options[g_activeTabID]={pagerId:"pages", tblId:"tbl", showSelect: true, canSelectRow:false,showStyle:false,
		canEdit: {% if request|reqHasPerm:"change" %}true{% else %}false{% endif %},
		canAdd: {% if request|reqHasPerm:"add" %}true{% else %}false{% endif %},
		canDelete: {% if request|reqHasPerm:"delete" %}true{% else %}false{% endif %},
		canSearch: true, keyFieldIndex:"0", title:'{{ dataOpt.verbose_name|cap }}',
	
		dlg_width:500,
		dlg_height:'auto',
		edit_col:1
	};

	jqOptions[g_activeTabID]=copyObj(jq_Options);
	jqOptions[g_activeTabID].rowNum={{ limit }}
	jqOptions[g_activeTabID].sortname='DeptID,PIN';
	jqOptions[g_activeTabID].pager='#id_pager_user_of_run';


function getSelected_empNames_ex(page_style){
	var emp=$("#id_grid_"+page_style).jqGrid('getGridParam','selarrrow');
	var empNames=[];
	if(typeof emp=='undefined') return empNames;
	for(var i=0;i<emp.length;i++)
	{
		pin=$("#id_grid_"+page_style).jqGrid('getCell',emp[i],4);
		empNames.push(pin)
	}

       return empNames;
}
function getSelected_empPin_ex(page_style){
	var emp=$("#id_grid_"+page_style).jqGrid('getGridParam','selarrrow');
	var empNames=[];
	if(typeof emp=='undefined') return empNames;
	
	for(var i=0;i<emp.length;i++)
	{
		pin=$("#id_grid_"+page_style).jqGrid('getCell',emp[i],3);
		empNames.push(pin)
	}

	return empNames;
}

	
function get_user_schedule_htm(){
    /*
	var user_schedule_html=""
		+"<table id='changelist' border='0' style=' width: 100%;'>"
		+"<tr><td>"
			+"<input type='text' style='display:none;' value='0' id='isTmporary' />"
		+"</td></tr>"
	
		+"<tr>"
			+"<td colspan=2 style='vertical-align:top;'><div id='show_dept_emp_tree' style='height:300px;'><table id='id_grid_' ></table><div id='id_pager_'></div></td>"
		+"</td></tr>"

*/
		//+"<tr><td colspan='3'><div id='id_shift_details'><fieldset style='border:1px solid #77B7DE;'><legend>{%trans 'Employee shift details' %}</legend><div id='id_shift_details_h' style='height:100%;width:960px;overflow:auto;'>"
		//	+"<div id='tz'>"
		//	+"</div></div></fieldset>"
		//	+"<div>"
	
	
		//		+"<span style='float:left;'><img src='/media/img/hint.gif' style='padding-right:3px;'></img><a id='schedule_hints' title='{%trans '1.如果仅选择单位(不选择人员)时，系统将对该单位下的所有人员进行排班  2.对于有规律上班的人员请先设置好班次然后进行周期排班,否则使用临时排班功能  3.清除临时排班是清除指定时间的临时排班,清除排班是清除指定时间的所有排班  4.在排班详情时段条上双击可删除所排的时段'%}' href='#'>提示</a></span>"
		//		+"<span id='id_error' style='float:right;'></span>"
	
		//	+"</div>"
		//	+"</div>"
		//+"</td></tr>"
		+"</table>"
		return user_schedule_html;
	}
	
function loadPage_user_of_run()
{
		
	var ComeTime=$("#id_ComeTime_user_of_run").val();
	var EndDate=$("#id_EndTime_user_of_run").val();
	
	var urlStr="/iclock/att/searchComposite/?flag=shift3"	
	 urlStr=urlStr+"&startDate="+ComeTime+"&endDate="+EndDate	
	$.ajax({
		type:"get",
		url:urlStr,
		dataType:"json",
		success:function(json){
			tblName[g_activeTabID]="shift2";
			//grid_disabledfields=json["disabledcols"]
			jqOptions[g_activeTabID].colModel=json["colModel"]
			//get_grid_fields(jqOptions)
			//hiddenfields(jqOptions)
		jqOptions[g_activeTabID].rowList=[]
		jqOptions[g_activeTabID].data=[]
		jqOptions[g_activeTabID].datatype='local'
		var hcontent=$("#"+g_activeTabID+" #id_content").height();
		var hbar=$("#"+g_activeTabID+" #id_top").height();
		var height=hcontent-hbar-130;
		jqOptions[g_activeTabID].height=height
		jqOptions[g_activeTabID].pager="#id_pager_user_of_run";

		$("#id_grid_user_of_run").jqGrid(jqOptions[g_activeTabID]);
			

		}
	});
		
		
		
		
}
	
function reloadShiftData(page)
{		
 		var deptids=getSelected_dept("showTree_"+g_activeTabID);
		if(deptids.length==0) return;
		var deptID=deptids[0]
		var ischecked=0;
		if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
			ischecked=1;
		var urlStr="/iclock/att/searchComposite/?flag=shift3&deptIDs="+deptID+"&isContainChild="+ischecked
		

	    var ComeTime=$("#id_ComeTime_"+page).val();
	    var EndDate=$("#id_EndTime_"+page).val();
	    if(ComeTime>EndDate){
            alert('开始时间不能大于结束时间')
            return
        }
	    //var urlStr="/iclock/att/searchComposite/?flag=shift2"	
	     urlStr=urlStr+"&startDate="+ComeTime+"&endDate="+EndDate	
		savecookie("search_urlstr",urlStr);
	    $("#"+g_activeTabID+" #id_grid_"+page).jqGrid('GridUnload')
	    //$.jgrid.gridUnload("#id_grid_"+page)
	    $.ajax({
		    type:"get",
		    url:urlStr,
		    dataType:"json",
		    success:function(json){
			    tblName[g_activeTabID]="shift3";
			    //grid_disabledfields[g_activeTabID]=json["disabledcols"]
			    jqOptions[g_activeTabID].colModel=json["colModel"]
			    //get_grid_fields(jqOptions[g_activeTabID])
			    //hiddenfields(jqOptions[g_activeTabID])
		jqOptions[g_activeTabID].pager="id_pager_user_of_run"
		jqOptions[g_activeTabID].url=urlStr
		//jqOptions.height=200;
		jqOptions[g_activeTabID].rowNum=100
		jqOptions[g_activeTabID].rowList=[]
		jqOptions[g_activeTabID].datatype='json'
		var hcontent=$("#"+g_activeTabID+" #id_content").height();
		var hbar=$("#"+g_activeTabID+" #id_top").height();
		var height=hcontent-hbar-130;
		jqOptions[g_activeTabID].height=height
		renderGridData(page,jqOptions[g_activeTabID])
			    
    
		    }
	    });
    
    
    
	
}

function _getDeptEmpData(page){
        ShowDeptData(page,true)
	
	var zTree = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
	zTree.setting.check.enable = false;
	zTree.setting.callback.onClick = function onClick(e, treeId, treeNode){
		var deptID=treeNode.id;
		var deptName=treeNode.name;
		$.cookie("dept_ids",deptID, { expires: 7 });
		$("#"+g_activeTabID+" #hidden_selDept").val(deptID);
		$("#"+g_activeTabID+" #hidden_depts").val(deptID);
		$("#"+g_activeTabID+" #hidden_deptsName").val(deptName)
		var ischecked=0;
		if($("#id_cascadecheck_"+page).prop("checked"))
			ischecked=1;
		var urlStr="/iclock/att/searchComposite/?flag=shift3&deptIDs="+deptID+"&isContainChild="+ischecked
		

	    var ComeTime=$("#id_ComeTime_user_of_run").val();
	    var EndDate=$("#id_EndTime_user_of_run").val();
	    if(ComeTime>EndDate) {
            alert('开始时间不能大于结束时间')
            return
        }
	    //var urlStr="/iclock/att/searchComposite/?flag=shift2"	
	     urlStr=urlStr+"&startDate="+ComeTime+"&endDate="+EndDate	
		savecookie("search_urlstr",urlStr);
	    $("#id_grid_"+page).jqGrid('GridUnload')
	    //$.jgrid.gridUnload("#id_grid_"+page)
	    $.ajax({
		    type:"get",
		    url:urlStr,
		    dataType:"json",
		    success:function(json){
			    tblName[g_activeTabID]="shift3";
			    grid_disabledfields[g_activeTabID]=json["disabledcols"]
			    jqOptions[g_activeTabID].colModel=json["colModel"]
			    get_grid_fields(jqOptions[g_activeTabID])
			    hiddenfields(jqOptions[g_activeTabID])
		jqOptions[g_activeTabID].pager="#id_pager_"+page;
		jqOptions[g_activeTabID].url=urlStr
		//jqOptions.height=200;
		jqOptions[g_activeTabID].rowNum={{limit}}
		jqOptions[g_activeTabID].rowList=[]
		jqOptions[g_activeTabID].datatype='json'
		var hcontent=$("#"+g_activeTabID+" #id_content").height();
		var hbar=$("#"+g_activeTabID+" #id_top").height();
		var height=hcontent-hbar-130;
		jqOptions[g_activeTabID].height=height
		renderGridData('user_of_run',jqOptions[g_activeTabID])
			    
    
		    }
	    });

		
	}
	
}
		
$(function(){
	initwindow_tabs();
	var hcontent=$("#"+g_activeTabID+" #id_content").height();
	var hbar=$("#"+g_activeTabID+" #id_top").length>0?$("#"+g_activeTabID+" #id_top").height():0;
	var h=hcontent-hbar-80
	//$('.module').css('height',h)

	page_tab_user_of_run='user_of_run'
	setDate(page_tab_user_of_run)

	var html="<span id=id_opt_tree><input type='checkbox' id='id_cascadecheck_tab_iclock_USER_OF_RUN'/>{%trans '级联下级单位' %}</span>"
	$("#tab_iclock_USER_OF_RUN #id_west").html(html)
	html="<div id='show_dept_tree_'>"
		+"<ul id='showTree_tab_iclock_USER_OF_RUN' class='ztree' style='margin-left: 0px;height:100%'></ul>"
		+"</div>"   
	$("#west_content_tab_iclock_USER_OF_RUN").html(html)
	//var h=$("#"+g_activeTabID+" #west_content").height()-20
	//$('#showTree_'+g_activeTabID).css('height',h)
	
	$("#tab_iclock_USER_OF_RUN #id_reload").click(function(){
	    reloadShiftData(page_tab_user_of_run)
	    
	    })
	
	$("#"+g_activeTabID+" #queryButton").click(function(){
		createQueryDlg_USER_OF_RUN();
	});
	var inputEl = $("#"+g_activeTabID+" .search-input");
         defVal[g_activeTabID] = inputEl.val();
    	 inputEl.on("focus",function(){
		             var _this = $(this);
				if (_this.val() == defVal[g_activeTabID]) {
				    _this.val('');
				    _this.css('color','#000000');
				    //_this.attr('role','disabled')
				}
		})
	inputEl.on("blur",function(){
		        var _this = $(this);
			if (_this.val() == '') {
			    _this.val(defVal[g_activeTabID]);
			    _this.css('color','#CCCCCC');
			    _this.attr('role','defvalue')
			}
			else
			    _this.attr('role','cansearch')
		})
	inputEl.on("keydown",function(event) {
			if (event.which == 13) {
			      var _this = $(this);
			       _this.attr('role','cansearch')
			 }
		})
	
	
	//getDept_and_emp_ex(250);
	//getDept_to_show_emp(260,300,'',page_tab_user_of_run,false);  //生成单位员工
	
	_getDeptEmpData(g_activeTabID)
	loadPage_user_of_run()
	
	//var h=$('#id_content').height()-$('#changelist').height()-40
	//$('#id_shift_details_h').css('height',h)
	//$("#tz").html("<div align='center'><h4><img src='/media/img/hint.gif'/>"+gettext("Click the employee to show the employee shift details!")+"</h4></div>");

/*
	var jqOptions4=copyObj(jq_Options);
	jqOptions4.colModel=jqOptions.colModel
	jqOptions4.height=200
	jqOptions4.url=''
	jqOptions4.rowList=[]
	jqOptions4.datatype='local'
	jqOptions4.pager="#id_pager_id_empshifts";
	renderGridData('id_empshifts',jqOptions4)
*/
	$.ajax({ 
		type: "POST",
		url:"/iclock/att/getData/?func=shifts",
		dataType:"json",
		success:function(json){
			shifts=json;
		}
	});
	$.ajax({
		type:"POST",
		url: "/iclock/att/attrule/",
		dataType:"json",
		success:function(json){
			weekStartDay=json[0].WorkWeekStartDay;
		}
	});

	$.ajax({ 
		type: "POST",
		url:"/iclock/att/getData/?func=schClass",
		dataType:"json",
		success:function(json){
			schClass_uor=json;
		}
	});


	
	$("#"+g_activeTabID+" #searchButton").click(function(){
		searchShowEmp_user_of_run();
	})

	$("#"+g_activeTabID+" #searchbar").keypress(function(event){
		if(event.keyCode==13){
			searchShowEmp_user_of_run();
		}	
	})
/*	
	$("#btn-schedule").click(function(){
		add_empShift()
	})
*/	
/*
	$("#btn-tmp-schedule").click(function(){
		add_tmpShift()
	})
*/
/*
	$("#btn-addschclass").click(function(){
		addsch_tmpShift()
	})
	$("#btn-clearschclass").click(function(){
		clearall_tmpShift()
	})

	$("#btn-clearAllschclass").click(function(){
		clearall_tmpShift('shifts')
	})
	
	$("#btn-deptschedule").click(function(){
		deptschedule_set()
	})
*/	
//    $("#"+g_activeTabID+" #id_custom").click(function(){
//	ShowCustomField();
//    });
//	$("#"+g_activeTabID+" #id_custom").remove()

});
function strOfData_user_of_run(data)
{
	return stripHtml(data.PIN)+" "+data.EName;
}

function setDate(page_style)
{

	$("#id_ComeTime_"+page_style).datepicker(datepickerOptions);
	$("#id_EndTime_"+page_style).datepicker(datepickerOptions);
	var currDate=new Date();
	//td=moment().format("YYYY-MM-DD")
	
	td=currDate.getFullYear()
		+"-"
		+(currDate.getMonth()+1<10?"0"+(currDate.getMonth()+1):currDate.getMonth()+1)
		+"-"
	day=(currDate.getDate()<10?"0"+currDate.getDate():currDate.getDate())
	$("#id_ComeTime_"+page_style).val(td+"01")
	$("#id_EndTime_"+page_style).val(td+day)
	
	/*if(loadcookie("id_ComeTime_"+page_style)){
		$("#id_ComeTime_"+page_style).val(loadcookie("id_ComeTime_"+page_style))
		$("#id_EndTime_"+page_style).val(loadcookie("id_EndDate_"+page_style))
	}
	else{
		$("#id_ComeTime_"+page_style).val(td+"01")
		$("#id_EndTime_"+page_style).val(td+currDate.getDate())
	}*/

}

 
function add_empShift(){		
		var emp=getSelected_emp_ex(page_tab_user_of_run)
		//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
		
		//var deptName=$("#show_dept_emp_tree").find("#hidden_deptsName").val()
		
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
		
		
		var empNames=getSelected_empNames_ex(page_tab_user_of_run);
		var empPin=getSelected_empPin_ex(page_tab_user_of_run);
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
		
		$("#isTmporary").val(0)
		var isError=false		//validate_form(1);

		if(ComeTime!=""&&EndDate!="")
		{
			savecookie("id_ComeTime_"+page_tab_user_of_run,ComeTime);
			savecookie("id_EndDate_"+page_tab_user_of_run,EndDate);
		}

		if(isError)
		{	
			alert("{%trans 'Please check that you select one or more employees or click department and the date is validate and the Beginning date is earlier than the Ending date!'%}");
		}
		else{
			var action=false;
			if(emp.length<=0){
				totalRecCnt_emp=$("#id_grid_"+page_tab_user_of_run).jqGrid('getGridParam','records')

				if(totalRecCnt_emp>0)
					action=confirm("{%trans "Are you sure shift for the whole department"%}\n"+deptName)
				else
				{
					alert(deptName+"  "+"{%trans 'no employee'%}");
				
				}
			}
			if(action ||emp.length>0){
				var cTime=ComeTime.split("-");
				var days=validate_date(ComeTime,EndDate)+1;
				var cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
				$("#id_error").css("display","none");
				$.cookie("ComeTime_"+page_tab_user_of_run,ComeTime, { expires: 7 });
				$.cookie("EndDate_"+page_tab_user_of_run,EndDate, { expires: 7 });
				queryStr="emp="+(emp.length>0?emp[0]:'')+"&deptIDs="+deptIDs
				var eTitle=""
				if(emp.length>0){
					for(var t=0;t<emp.length;t++)
					{
						eTitle+=empNames[t]+"["+empPin[t]+"]"
						if (t<5)
							eTitle+=" "
						else
						{
							eTitle+="..."
							break
						}
					}
				}
				else
					eTitle+="{%trans 'By Department'%}:"+deptName
				
				showEmpShiftDlg(eTitle)
				//showDefalutAuto()
				//getAssignedShifts_html();
			}
		}
	}
	
function saveEmpShift(){
		       $.blockUI({title:'',theme: true ,baseZ:10000,message: '<h1><img src="/media/img/loading.gif" /> <br>{%trans '请稍等......'%}</br></h1>'});
			var emp=getSelected_emp_ex(page_tab_user_of_run)
			//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
			
			var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
			var nodes = treeObj.getSelectedNodes();
			var deptIDs='';
			var deptName=''
			if (nodes.length>0)
			{
			    deptIDs=nodes[0].id
			    deptName=nodes[0].name;
			}
			
			
			
			
			$("#id_error_sec").css("display","none");

			var sTimeTbl=getSelected_SchClass();
			$("#id_sTimeTbl").val(sTimeTbl);
			addShift();
			$("#id_sAssigned_shifts").val(get_assignedShifts_String(assignedShifts));
			var ischecked=0;
			if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
				ischecked=1;
			var queryStr=$("#id_edit_form_user_of_run").formSerialize()+"&isContainChild="+ischecked+"&UserIDs="+emp+"&deptIDs="+deptIDs;
			$.ajax({ type: "POST",
				url: "/iclock/att/FetchSchPlan/",
				data:queryStr,
				dataType:"json",
				success: function(ret){
			    reloadShiftData(page_tab_user_of_run)
				$("#id_error_sec").css("display","block");
				$("#id_error_sec").html("<ul class='errorlist'><li>"+ret.message+"</li></ul>");
			$.unblockUI();
				},
				error: function(request, errorMsg){
					 alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg));
					$.unblockUI();
					}
			});
}
	



function addShift()
{
			var shift_id=$("#id_shifts").val();
			var shift_name=$("#id_shifts").get(0).options[$("#id_shifts").get(0).selectedIndex].text;
			var startDate=$("#id_startUseDate").val();
			var endDate=$("#id_endUseDate").val();
			var numID=0;
			var assignedlth=assignedShifts.length; //已排班
			if(assignedlth>0)
				numID=assignedShifts[assignedlth-1].numID+1;
			else
				numID+=1;
			tmp={"numID":numID,"SchId":shift_id,"SchName":shift_name,"StartDate":startDate,"EndDate":endDate};
			var is_add=is_ready_add(shift_id,startDate,endDate);
			if(!valiDate(startDate)||!valiDate(endDate))
			{
					$("#id_error_sec").css("display","block");
					$("#id_error_sec").html("<ul class='errorlist'><li>{%trans 'Enter a valid date/time'%}</li></ul>");
			}
			else if(shift_id==""||startDate==""||endDate==""||validate_date(startDate,endDate)<0)
			{	
					$("#id_error_sec").css("display","block");
					$("#id_error_sec").html("<ul class='errorlist'><li>{%trans 'Please select the shift and startdDate and endDate and startDate is smaller than endDate'%}</li></ul>");
			}
			else if(!is_add){
					assignedShifts=[]
					assignedShifts.push(tmp);
					//getAssignedShifts_html();
					$("#id_error_sec").css("display","none");
			}	
}	




	
function showEmpShiftDlg(eTitle)
{
		assignedShifts=[]
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
			var block_html="<div id='ArrangeShifts' >"
				+"<div class='dcontent'><form id='id_edit_form_user_of_run'>"
				+"<table align='center'>"
					+"<tr>"
					+"<td><fieldset style='height:260'><legend>{%trans 'Shifts'%}</legend><div ><table><tr><td colspan='2'><table><tr><td><select  id='id_shifts' size='11' style='width:200px !important;height:220px;'>"+getShifts_html()+"</select></td>"
					+"</tr></table></td>"
					+"</tr>"
					+"</table></div></fieldset></td>"
					+"<td><fieldset style='height:260'><legend>{% trans '时间范围'%}</legend>"
					+"<div id='id_assigned_date' style='height:230px;width:300px;'>"
					+"<div style='padding:20px;'><label class='required'>{%trans 'Starting Date:'%}</label><input type='text' size='11' id='id_startUseDate' maxlength='10' value='"+ComeTime+"'/></div>"
					+"<div style='padding:20px;'><label class='required'>{%trans 'Ending Date:'%}</label><input type='text' size='11'  id='id_endUseDate' maxlength='10' value='"+EndDate+"'/></div>"
					+"</div>"
					+"<div id='id_assigned_shifts' style='display:none;height:230px;width:300px !important;overflow:auto;'></div></fieldset></td>"
					+"<td>"
					+"<fieldset style='height:260px;width:300px;'><legend>{%trans 'Auto assign time-tables'%}</legend>"
					+"<div style='height:225px;width:250px !important;align:center'>"
					+"<table><tr><td><input type='checkbox' name='auto_assign' id='id_auto_assign'/>{%trans 'Auto assign time-tables'%}</td></tr>"
					+"<tr><td>{%trans '最小的匹配时间间隔:'%}</td></tr>"
					+"<tr><td><span><input type='text' style='width:40px !important;' maxlength='3' size='5' id='id_least_days' name='least_days' value='' />{% trans 'Day' %}</span><span><input type='text'  style='width:40px !important;' maxlength='3' size='5' id='id_least_hours' name='least_hours' value='4' />{% trans 'Hour' %}</span></td></tr>"
					+"<tr><td>{%trans 'Maybe Used time-table:'%}</td></tr>"
					+"<tr><td><div style='height:150px;width:290px;overflow:auto;'><table >"+getSchClass_html_user_of_run()+"</table></div></td></tr>"
					+"</table></div>"
					+"</fieldset>"
					+"</td>" 
						
					+"</tr>"									
					+"<tr><td><span id='id_error_sec'></span></td></tr>"
					+"<tr><td>"+"</td></tr>"
					+"<input type='hidden' value='' name='sAssigned_shifts' id='id_sAssigned_shifts' />"
					+"<input type='hidden' value='' name='sTimeTbl' id='id_sTimeTbl' />"
					+"</td></tr>"
							
				+"</table></form>"
				+"</div>"

				//+"<div id='dlg_btn' style='text-align:right; margin-top: 10px; margin-right: 20px;margin-bottom:5px;'>"
				//+"<input type='button' value='"+gettext('Submit')+"' id='btnShowOK'  class='ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only'>&nbsp;&nbsp;&nbsp;"
				//+"<input type='button' value='"+gettext('Return')+"' id='btnCancel' class='ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only'>&nbsp;&nbsp;&nbsp;"
				//+"</div>"
				
			+"<div id='id_Shift_Detail_dlg' style='overflow: auto; height: 190px;width:980px; margin-left:10px'>"
			+"<fieldset><legend></legend>"
			+"<div style='overflow: auto; height: 150px; width:960px;'>"
			+"<div id='tz_dlg'></div></div></fieldset></div>"
			+"<div id='id_numrun_tip' class='numrun_tip' style='margin-left:15px；dsiplay:none'></div>"

				
				
				
				+"</div>"
		$(block_html).dialog({modal:true,
			resizable:false,
			width: 1024,
			height:580,
			maxWidth:1024,
			title:gettext("Arrange Shifts")+"("+eTitle+")",
			close:function(){$(this).dialog("destroy");},
			buttons:[
			    {id:"btnShowOK",text:'{% trans "save and return" %}',click:function(){saveEmpShift();}},
			    {id:"btnCancel",text:'{%trans "Return" %}',click:function(){$(this).dialog("destroy"); }}
			]
			
			
		});
		$('#id_shifts').css("display","block");
		//$("#btnCancel").click(function(){$("#ArrangeShifts").remove();});
		showshift($("#id_shifts").val());
		$("#id_startUseDate").datepicker(datepickerOptions);
		$("#id_endUseDate").datepicker(datepickerOptions);
		//addShift();
		$("#id_shifts").change(function(event) {
			var shid=$(this).val();
			showshift(shid);
			//addShift();
		});
		
		$("#id_auto_assign").click(function(){
			if($(this).prop("checked"))
			{	
				$("#id_least_days").removeAttr("disabled");
				$("#id_least_hours").removeAttr("disabled");
				$(".class_select_schClass").removeAttr("disabled");
				$("#is_select_all_shcClass").removeAttr("disabled");
			}	
			else{
				$("#id_least_days").attr("disabled","disabled");
				$("#id_least_hours").attr("disabled","disabled");
				$(".class_select_schClass").attr("disabled","disabled");
				$("#is_select_all_shcClass").attr("disabled","disabled");
			}
		});
		
		
		

}

	
function add_tmpShift(){
		var emp=getSelected_emp_ex(page_tab_user_of_run);
		//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
		//var deptName=$("#show_dept_emp_tree").find("#hidden_deptsName").val()
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
		
		
		
		var empNames=getSelected_empNames_ex(page_tab_user_of_run);
		var empPin=getSelected_empPin_ex(page_tab_user_of_run);
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
		var isError=validate_form_user_of_run(1);

		if(ComeTime!=""&&EndDate!=""){
			savecookie("id_ComeTime_"+page_tab_user_of_run,ComeTime);
			savecookie("id_EndDate_"+page_tab_user_of_run,EndDate);
		}
		if(isError){	
			alert("{%trans 'Please check that you select one or more employees and the date is validate!'%}");
		}
		else{
			var action=false;
			var cTime=ComeTime.split("-");
			var days=validate_date(ComeTime,EndDate)+1;
			var cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
			$("#id_error").css("display","none");
			$.cookie("ComeTime_"+page_tab_user_of_run,ComeTime, { expires: 7 });
			$.cookie("EndDate_"+page_tab_user_of_run,EndDate, { expires: 7 });
			var eTitle=""
			var action=false;
			if(emp.length<=0){
				totalRecCnt_emp=$("#id_grid_"+page_tab_user_of_run).jqGrid('getGridParam','records')
				if(totalRecCnt_emp>0){
					action=confirm("{%trans "Are you sure tempoary shift for the selected employee"%}{%trans "or department"%}({%trans "employee:"%}"+emp.length+"):\n"+eTitle+"\n{%trans "the between"%}"+ComeTime+"{%trans "and" %}"+EndDate+"{%trans "?" %}")
				}	
				else{
					alert(deptName+"  "+"{%trans 'no employee'%}");
					return
				}
			}
			else{
				if(emp.length>0){
					if(empNames.length>3)
						eTitle+=empNames[0]+"["+empPin[0]+"]"+","+empNames[1]+"["+empPin[1]+"]"+","+empNames[2]+"["+empPin[2]+"]"+"...";
					else
						eTitle+=empPin;
				}
				else
					eTitle+=deptName;
				action=confirm("{%trans "Are you sure tempoary shift for the selected employee"%}{%trans "or department"%}({%trans "employee:"%}"+emp.length+"):\n"+eTitle+"\n{%trans "the between"%}"+ComeTime+"{%trans "and" %}"+EndDate+"{%trans "?" %}")

			}
			if(action){
				$("#isTmporary").val(1)
				var ischecked=0;
				if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
					ischecked=1;
				var queryStr="StartDate="+ComeTime+"&isContainChild="+ischecked+"&deptIDs="+deptIDs+"&EndDate="+EndDate+"&UserIDs="+emp;
				$.ajax({ 
					type: "POST",
					url:"/iclock/att/tmpshifts/",
					data:queryStr,
					dataType:"json",
					success:actionSucess_NoReload
				});
			}
			else{
				$("#isTmporary").val(0)
			}
		}
	}

function createEvents()
{
		$('#id_schclasses .class_select_schClass').each(function() {
			var eventObject = {
				alt:$(this).attr('Alt'),
				title: $.trim($(this).attr('Alt1')) 	// use the element's text as the event title
			};
			$(this).data('eventObject', eventObject);
			$(this).draggable({
				zIndex: 999,
				revert: true,      			// will cause the event to go back to its
				revertDuration: 0  			//  original position after the drag
			});
		});
}

function postShiftData(eventdata)
{		$.blockUI({title:'',theme: true ,baseZ:10000,message: '<h1><img src="/media/img/loading.gif" /> <br>{%trans '正在操作中......'%}</br></h1>'});
		var sches=[]
		sches.push(eventdata.events.alt)
		//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
		
		
		
		
		var emp=getSelected_emp_ex(page_tab_user_of_run);		
		var tmp=eventdata.events.start;
		//var m="00"+(tmp.month()+1);
		//var d="00"+tmp.date();
		//var sDates=tmp.year()+"-"+m.substring(m.length-2)+"-"+d.substring(d.length-2)
		sDates=tmp.format("YYYY-MM-DD")
		var dates=[]
		dates.push(sDates)
		var overTime=$("#id_overTime_user_of_run").val();
		var sTimeTbl=sches
		var Dates=dates;
		var del_data=0
		if(eventdata.delta&&eventdata.delta!=0)
			del_data=eventdata.delta
		var ComeTime=''
		var EndDate=''
		var eventname=eventdata.eventName
		if (eventname=='eventResize' || eventname=='eventdrop'){
			ComeTime=sDates
			var tmp=eventdata.events.end;
			if(tmp==null){
				tmp=eventdata.events.start;
			}
			//var m="00"+(tmp.month()+1);
			//var d="00"+tmp.date();
			//var eDates=tmp.year()+"-"+m.substring(m.length-2)+"-"+d.substring(d.length-2)
			eDates=tmp.format("YYYY-MM-DD")
			
			EndDate=eDates
		}
		if(sTimeTbl==null || sTimeTbl=="" || Dates.length<=0){
			$("#id_error_sec").css("display","block");
			$("#id_error_sec").html("<ul class='errorlist'><li>{%trans 'Please select Time-table and Date!'%}</li></ul>");
			return false;
		}
		else{
			$("#id_error_sec").css("display","none");
			$("#id_sTimeTbl").val(sTimeTbl);
			$("#id_sDates").val(Dates);
			var ischecked=0;
			if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
				ischecked=1;
			var queryStr=$("#id_edit_form_user_of_run").formSerialize()+"&isContainChild="+ischecked+"&StartDate="+ComeTime+"&EndDate="+EndDate+"&deptIDs="+deptIDs+"&UserIDs="+emp+"&deldata="+del_data+"&eventName="+eventname;
			$.ajax({ type: "POST",
				url: "/iclock/att/addTemparyShifts/",
				data:queryStr,
				dataType:"json",
				success: function(ret){
					$("#id_error_sec").css("display","block");
					$("#id_error_sec").html("<ul class='errorlist'><li>"+ret.message+"</li></ul>");
					$.unblockUI()
				},
				error: function(request, errorMsg){
					alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg));
					$.unblockUI()
				}
			});
		}
}
function delShiftData(ComeTime,EndTime,id)
{
	//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
	
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
	
	
	var emp=getSelected_emp_ex(page_tab_user_of_run);
	$("#id_error_sec").css("display","none");
	var ischecked=0;
	if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
		ischecked=1;
	var queryStr="isContainChild="+ischecked+"&StartDate="+ComeTime+"&EndDate="+EndTime+"&deptIDs="+deptIDs+"&UserIDs="+emp+"&sTimeTbl="+id+"&flag=del_temp";
	 $.ajax({ type: "POST",
		url: "/iclock/att/deleteEmployeeShift/",
		data:queryStr,
		dataType:"json",
		success: function(data){
			if(data['ret']==0){
				$("#id_error_sec").css("display","block");
				$("#id_error_sec").html("<ul class='errorlist'><li>{%trans '操作成功'%}</li></ul>");
				delEmpShift_success(data)
			}
		},
		error: function(request, errorMsg){
			alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg)); 
		}
	});
}

function addsch_tmpShift(){
	var emp=getSelected_emp_ex(page_tab_user_of_run);
	var empNames=getSelected_empNames_ex(page_tab_user_of_run);
	var empPin=getSelected_empPin_ex(page_tab_user_of_run);
	//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
	//var deptName=$("#show_dept_emp_tree").find("#hidden_deptsName").val()
	var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
	var nodes = treeObj.getSelectedNodes();
	var deptIDs='';
	var deptName='';
	
	if (nodes.length>0)
	{
	    deptIDs=nodes[0].id
	    deptName=nodes[0].name;
	}
	var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
	var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
	var isError=validate_form_user_of_run(1);
	if(isError)
	{	
		//$("#id_error").css("display","block");
		alert("{%trans 'Please check that you select one or more employees and the date is validate!'%}");
	}
	else{


		var cTime=ComeTime.split("-");
		var days=validate_date(ComeTime,EndDate)+1;
		var	cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
		$("#"+g_activeTabID+" #id_error").css("display","none");
		$.cookie("ComeTime",ComeTime, { expires: 7 });
		$.cookie("EndDate",EndDate, { expires: 7 });
		var eTitle=""
		if(emp.length>0){
			if(empNames.length>3)
				eTitle+=empNames[0]+"["+empPin[0]+"]"+","+empNames[1]+"["+empPin[1]+"]"+","+empNames[2]+"["+empPin[2]+"]"+"...";
			else
				eTitle+=empPin;
		}
		else
			eTitle+=deptName;
		var block_html="<div id='TemporaryShifts' style='width:600px;padding-top:0;padding-bottom:0;'>"
			+"<div class='dcontent'><form id='id_edit_form_user_of_run'>"
			+"<table align='center'>"
			+"<tr><td>&nbsp;</td></tr>"
			+"<tr>"
			+"<td><fieldset><legend>{%trans 'Time-table:'%}</legend>"
			+"<div id='id_schclasses' style='height:280px;width:250px;overflow:auto;'><table >"+getSchClass_html_tmp()+"</table></div></fieldset>"
			+"<fieldset><legend></legend><input type='checkbox' id='is_overtime' name='is_OT'/>{% trans 'Is designed overtime?' %}"
			+"<div id='show_ot' style='padding-left:3px;'>{% trans 'Overtime:' %}<input type='text' id='id_overTime_user_of_run' size='5' name='OverTime' value='0'/>{% trans 'minute(s)' %}</div>"
			+"</fieldset></td>"
			+"<td>"
			+"<div id='calendar' style='width:650px;float: right;'></div>"
			+"</td>"
			+"</tr>"
			+"<tr><td><span id='id_error_sec'></span></td><td>"
			+"<div id='dlg_btn' style='text-align:right; margin-top: 10px; margin-right: 20px;margin-bottom:10px;'>"
			+"<input type='button' value='"+gettext('Return')+"' id='btnCancel_user_of_run' class='ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only'>&nbsp;&nbsp;&nbsp;"
			+"</div>"
			+"</td></tr>"
			+"<input type='hidden' value='' name='sTimeTbl' id='id_sTimeTbl' />"
			+"<input type='hidden' value='' name='sDates' id='id_sDates' />"
			+"<input type='hidden' value='' name='sDates_st' id='id_sDates_st' />"
			+"<input type='hidden' value='' name='sDates_et' id='id_sDates_et' />"
			+"</td></tr>"
			+"</table></form>"
						
			+"</div>"
			+"<div class='ui-widget'>"
				+"<div class='ui-widger-header ui-corner-all' style='margin-top: 20px; padding: 0 .7em;'>" 
					+"<p><span class='ui-icon ui-icon-info' style='float: left; margin-right: .3em;'></span>"
					+"<strong>操作提示:</strong>1.可以用鼠标将时段拖到相对应的日期；2.可以用鼠标移动或拉长或缩短已排时段；3.可以用鼠标单击某天进行操作；4.点击时段删除</p>"
				+"</div>"
			+"</div>"

		$(block_html).dialog({modal:true,
			resizable:false,
			width: 1000,
			height:540,
			title:gettext("Temporary Shifts")+"("+eTitle+")",
			close:function(){$("#TemporaryShifts").remove();}	
		});
		
		createEvents()
		cal=$('#calendar').fullCalendar({
			header: {
				left: 'prev,next, today',
				center: 'title',
				right: 'month'
			},		
			buttonText:{
				prev:'向前',
				next:'向后',
				today:'今天',
				month:'按月',
				agendaWeek:'按周',
				agendaDay:'按天'
			},
			titleFormat:'YYYY年MM月DD日',
			allDayText:'整天',
			aspectRatio:2.0,
			axisFormat:'H(:mm)',
			timeFormat:{agendaDay:'H:mm{ - H:mm}',agendaWeek:'H:mm{ - H:mm}'},
			theme:true,
			selectable: true,
			unselectCancel:'',
			eventBackgroundColor:'#ff0000',
			unselectAuto:false,
			dayNames:['周日','周一','周二','周三','周四','周五','周六'],
			dayNamesShort:['周日','周一','周二','周三','周四','周五','周六'],
			editable: true,
			droppable: true,
			diableResizing:false,
			drop: function(date, allDay) { // this function is called when something is dropped
				var originalEventObject = $(this).data('eventObject');
				var copiedEventObject = $.extend({}, originalEventObject);
				
				copiedEventObject.start = date;
				copiedEventObject.allDay = allDay;
				$('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
				var copyevent=$.extend({}, eventObj);
				copyevent.events=copiedEventObject
				copyevent.eventName='drop'
				postShiftData(copyevent)
			},
			eventResize: function(calEvent, dayDelta, revertFunc) {
				if (dayDelta) {
				     var copyevent=$.extend({}, eventObj);
				    copyevent.events=calEvent
				    copyevent.eventName='eventResize'
				    //copyevent.delta=dayDelta.days()
				    postShiftData(copyevent)
				}else{
				     alert(revertFunc)
				}
				
			
			},
			eventResizeStart:function(event, jsEvent, ui, view ){
				var st=event.start.format("YYYY-MM-DD")
				var tmp=event.end;
				if(tmp==null){
					tmp=event.start;
				}
				var et=tmp.format("YYYY-MM-DD")
				$("#id_sDates_st").val(st)
				$("#id_sDates_et").val(et)
			 },
			eventDrop: function(event, delta) {
				var copyevent=$.extend({}, eventObj);
				copyevent.events=event
				copyevent.eventName='eventdrop'
				copyevent.delta=delta.days()
				postShiftData(copyevent)
			},
			eventDragStart:function(event, jsEvent, ui, view ){
				var st=event.start.format("YYYY-MM-DD")
				var tmp=event.end;
				if(tmp==null){
					tmp=event.start;
				}
				var et=tmp.format("YYYY-MM-DD")
				$("#id_sDates_st").val(st)
				$("#id_sDates_et").val(et)
			 },
			dayClick:function(start, allDay, jsEvent, view){
				DayForm_Html(start,allDay)
			},
			eventClick:function(calEvent, jsEvent, view){
				var start=calEvent.start;
				var end=calEvent.end;
				if(end==null){
					end=start
				}
				var daystr=start.format("YYYY-MM-DD")
				var dayend=end.format("YYYY-MM-DD")	
				var shiftid=calEvent.alt;
				var title=calEvent.title;
				str="{%trans "Are you sure delete temporary shift for the selected employee"%}{%trans "or department"%}({%trans "employee:"%}"+emp.length+"):\n"+title+"\n{%trans "the between"%}"+daystr+"{%trans "and" %}"+dayend+"{%trans "的排班"%}"
				action=confirm(str)
				if(action){
					ClearDayFormData(start,end,shiftid)
				}
			}
		})
		$("#btnCancel_user_of_run").click(function(){$("#TemporaryShifts").remove();});
	}
		
}


function showResponse_baidu_tishi(){
    $("#id_message").css("display","block")
	$("#id_message").html('<h1><img src="/media/img/loading.gif" /> <br>正在操作中......</br></h1>')
}
function importschclass_tmpShift(){
	var currDate=new Date();
	var year=currDate.getFullYear()
	var month=currDate.getMonth()+1
	var block_html="<form id='frmComebackDb' name='frmComebackDb' method='POST' action='/iclock/tasks/importschclasstmpShift/' enctype='multipart/form-data'>"
				+"<table>"
				+'<tr><td cols="3">&nbsp;</td></tr>'
				+'<tr><th>'+gettext("Support Upload Fields" )+'</th><th>'+gettext("Index in File" )+'</th></tr>'
				+'<tr><td><input id="id_PIN" name="PIN" type="checkbox" checked disabled/>'+gettext("考勤编号")+'</td>'
				+'<td><input name="PIN2file" id="id_PIN2file" type="text" value="1" style="width:100px !important;" readonly/></td>'
				+'</tr>'

				//+'<tr><td><input id="id_day" name="day" type="checkbox" checked disabled/>'+gettext("日")+'</td>'
				//+'<td><input name="day2file" id="id_day2file" type="text" value="4"  style="width:100px !important;" readonly/></td>'
				//+'</tr>'
				//+'<tr><td><input id="id_schid" name="schid" type="checkbox" checked disabled/>'+gettext("时段ID")+'</td>'
				//+'<td><input name="schid2file" id="id_schid2file" type="text" value="5"  style="width:100px !important;" readonly/></td>'
				//+'</tr>'
				+'<tr><td><input id="id_whatrowid" name="whatrowid" type="checkbox" checked disabled/>'+gettext("whatrowid")+'</td>'
				+'<td><input name="whatrowid2file" id="id_whatrowid2file" type="text" value="2"  style="width:100px !important;"/>行开始</td>'
				+'</tr>'
				+'<tr><td>导入时间</td><td><div><input name="year2file" id="id_year2file" type="text" value="'+year+'" style="width:40px !important;"/>'+gettext("年")
				+'<input name="month2file" id="id_month2file" type="text"  value="'+month+'" style="width:30px !important;"/>'+gettext("月")
				+'</div></tr>'
				+'<tr><td cospan="2"><input  type="hidden" name="fields" id="id_fields"/></td></tr>'
				+'</table>'
				+'<div style="float:left;">'
				+gettext("Upload file location")
				+'<div>'
				+"<input type='file' class='text' value='' name='fileUpload' id='fileUpload'/><br />"
				+'<br /><label>'+gettext("上传的格式为excel文件")+'</label>'
				+'<br /><label>'+gettext("时段ID可以在时段页面中查询")+'</label>'
				+'<br /><label>'+gettext("每次导入会删除填写月份数据，再做导入新数据，不会叠加")+'</label>'
				+'<br /><label>'+gettext("第1列数据为人员身份证号,第2列为姓名,第3列为填写月份第1天,第4列为第2天,以此类推")+'</label>'
                 +'<br /><a href="/media/img/att/att_schclass_import.xlsx" target="_blank"><label style="color:#FF9500;">>>> 获取导入模版</label></a>'
				+'<br />'
				//+'<div><input class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"  type="submit" value='+gettext("Submit")+' >'
				//+'<input id="btnCancel" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" type="button" value='+gettext("Cancel")+' ></div>'
				+'<div id="id_message"></div>'
				+'</div></div></form>'

		$(block_html).dialog({modal:true,
					resizable:false,
					width: 500,
					height:450,
					buttons:[{id:'btnShowOK',text:gettext("Submit"),click:function(){$(this).submit();showResponse_baidu_tishi();}},{text:gettext("Cancel"),click:function(){$(this).dialog("close"); }}],

							  title:gettext("排班导入"),
							  close:function(){$("#frmComebackDb").remove();}
							});
		var opts = {
				url:'/iclock/tasks/importschclasstmpShift/',
				dataType:'json',
				success: showResponse
			};

		$('#frmComebackDb').submit(function() {
			$(".errorlist").css("display","none");
			var flag=true;
			value1=$("#id_whatrowid2file").val();
			if(value1==""||value1.match(/^[1-9]\d*$/)==null){
				$("#id_whatrowid2file").after("<ul class='errorlist'><li>开始行必须为数字</li></ul>");
				return false;

			}
			if(flag){
				$(this).ajaxSubmit(opts);
			}
			return false;
		});

}




function DayForm_Html(start,allDay){
	var html="<div id='id_day_form'><div class='module' style='position:relative;'>"
		+"<table id='id_day_table'>"
	
		+"<tr><td><fieldset><legend>{%trans 'Time-table:'%}</legend>"
		+"<div id='id_schclasses' style='height:280px;width:250px;overflow:auto;'><table >"+getSchClass_day_tmp()+"</table></div></fieldset></td></tr>"
		+"<tr><td colspan='2'>"
		+"<input type='hidden' id='id_start' value='"+start+"' name='start' />"
		+"</td></tr>"
		+"<tr><td colspan='2'><span id='id_error'></span></td>"
		+"</table></form></td>"
		+"</tr></table></div></div>";
		options[g_activeTabID].dlg_width=300;
		options[g_activeTabID].dlg_height=430;
		$(html).dialog({modal:true,
			resizable:false,
			title:"{%trans 'Append'%}{%trans '时段'%}",
			width:options[g_activeTabID].dlg_width,
			height:options[g_activeTabID].dlg_height,
			buttons:[{text:"{% trans "添加时段" %}",click:function(){SaveDayFormData(start,allDay);  }},
					 {text:'{%trans "Return" %}',click:function(){$(this).dialog("destroy"); }}],
			close: function() {$("#id_day_form").remove();}});
}
function SaveDayFormData(start,allDay){
	var Dayshifts=[]
	var Dayshiftnames=[]
	$.each($(".class_select_shift"),function(){
		if(this.checked){
			Dayshifts.push(this.alt)
			Dayshiftnames.push(this.name)
		}
	});
	for(var i=0;i<Dayshifts.length;i++){
		var eventObject = {
			title: Dayshiftnames[i],
			start: start,
			end: start,
			alt:Dayshifts[i],
			allDay: allDay			
		};
		$('#calendar').fullCalendar('renderEvent', eventObject, true);
		var copyevent=$.extend({}, eventObj);
		var copiedEventObject = $.extend({}, eventObject);
		copiedEventObject.start = start;
		copiedEventObject.allDay = allDay;
		copyevent.events=copiedEventObject
		copyevent.eventName='drop'
		postShiftData(copyevent)
	}
	$("#id_day_form").remove();
}

function ClearDayFormData(start,end,id){
	$.blockUI({title:'',theme: true ,baseZ:10000,message: '<h1><img src="/media/img/loading.gif" /> <br>{%trans '正在操作中......'%}</br></h1>'});
	var daystr=start.format("YYYY-MM-DD")
	var dayend=end.format("YYYY-MM-DD")	
	$('#calendar').fullCalendar('removeEvents', function(CalEvent){
		var tmp=CalEvent.start;
		var daystr1=tmp.format("YYYY-MM-DD")
		var tmp=CalEvent.end;
		if(tmp==null){
			tmp=CalEvent.start;
		}
		var dayend1=tmp.format("YYYY-MM-DD")
		if(daystr1==daystr&&dayend1==dayend&&id==CalEvent.alt){
			return true;
		}	
	})
	delShiftData(daystr,dayend,id)
	$("#id_day_form").remove();
	$.unblockUI()
}

function clearall_tmpShift(sobj){
		var emp=getSelected_emp_ex(page_tab_user_of_run);
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
		//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val()
		//var deptName=$("#show_dept_emp_tree").find("#hidden_deptsName").val()
		
		
		var empNames=getSelected_empNames_ex(page_tab_user_of_run);
		var empPin=getSelected_empPin_ex(page_tab_user_of_run);
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
		var isError=validate_form_user_of_run(1);
		//$("#isTmporary").val(0)
		//$("#id_addsch_tmpShift").attr("disabled","disabled");
		if(isError){	
			$("#id_error").css("display","block");
			$("#id_error").html("<ul class='errorlist'><li>{%trans 'Please check that you select one or more employees or click department and the date is validate and the Beginning date is earlier than the Ending date!'%}</li></ul>");
		}
		else{
			var action=false;
			var eTitle=""
			if(emp.length>0) {
                if (empNames.length > 3) {
                    eTitle += empNames[0] + "[" + empPin[0] + "]" + ", " + empNames[1] + "[" + empPin[1] + "]" + ", " + empNames[2] + "[" + empPin[2] + "]" + "...";
                } else if (empNames.length == 1){
                    eTitle += empNames[0] + "[" + empPin[0] + "]"
                }else if (empNames.length == 2){
                     eTitle += empNames[0] + "[" + empPin[0] + "]"+", " + empNames[1] + "[" + empPin[1] + "]"
				}else if (empNames.length == 3) {
                    eTitle += empNames[0] + "[" + empPin[0] + "]" + ", " + empNames[1] + "[" + empPin[1] + "]" + ", " + empNames[2] + "[" + empPin[2] + "]"
                }
            }else {
                eTitle += deptName;
            }
			if (sobj=='shifts') {
                if (eTitle== deptName){
                    str = "您确认删除  "+ eTitle+"  所有人员排班数据" + "\n{%trans "the between"%}" + ComeTime + "{%trans "and" %}" + EndDate
				}else{
                 		str = "您确认删除已选人员排班数据({%trans "employee:"%}" + emp.length + "):\n" + eTitle + "\n{%trans "the between"%}" + ComeTime + "{%trans "and" %}" + EndDate
				}
            }else {
                str = "{%trans "Are you sure delete temporary shift for the selected employee"%}{%trans "or department"%}({%trans "employee:"%}" + emp.length + "):\n" + eTitle + "\n{%trans "the between"%}" + ComeTime + "{%trans "and" %}" + EndDate + "{%trans " ? "%}"
            }
            action=confirm(str)
			if(action ){
				$("#id_error").css("display","none");
				var ischecked=0;
				if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
					ischecked=1;
				var queryStr="StartDate="+ComeTime+"&isContainChild="+ischecked+"&EndDate="+EndDate+"&deptIDs="+deptIDs+"&UserIDs="+emp;
				if (sobj=='shifts')
				queryStr+='&delshift=shifts'
				$.ajax({ 
					type: "POST",
					url:"/iclock/att/doDeleteTmpShifts/",
					data:queryStr,
					dataType:"json",
					success:function(ret){actionSucess_NoReload(ret,undefined)}
				});
			}
		}
	}
function Actionclick(id)
{
	$('#id_SaveNum_RUN').val(id)
	var r=$("#id_grid_num_run").jqGrid("getRowData",id)
	$('#id_ShowNum_RUN').val(r.Name)

}
function processAction()
{
	var apage='';
	var rows=$("#id_grid_num_run").jqGrid("getCol",1,true)
	for(var i=0;i<rows.length;i++)
	{
		var id=rows[i].id;
		var colData=rows[i].value;
		//var apage="<img src='/media/img/add.png'  onclick='Actionclick("+id+")'></img> "
		var apage="<a class='can_edit'  title='为单位选择默认班次' href='#' onclick='Actionclick("+id+")'>++++</a> "
		$("#id_grid_num_run").jqGrid('setRowData',id,{action:apage})
	}
}
function get_Num_Run()
{
	jqOptions2=copyObj(jq_Options);
	var url="/iclock/data/NUM_RUN/?t=NUM_RUN_list_ex.js";
		jqOptions2.colModel=[
			{'name':'id','hidden':true},
			{'name':'Name','width':100,'label':'{%trans '班次名称' %}'},
			{'name':'StartDate','width':80,'label':'{%trans '启用日期' %}'},
			{'name':'EndDate','width':80,'label':'{%trans '终止日期' %}'},
			{'name':'action','width':100,'label':'{%trans '添加默认班次' %}'}
		]
		jqOptions2.sortname="Num_runID";
		jqOptions2.sortorder="";
		jqOptions2.url=url
		jqOptions2.height=260
		jqOptions2.gridComplete=function(){
			processAction();
		}
		jqOptions2.rowNum=500
		jqOptions2.rowList=[]
		jqOptions2.pager="#id_pager_num_run";
		renderGridData("num_run",jqOptions2)

}
function get_SchClass()
{
	jqOptions3=copyObj(jq_Options);
	var url="/iclock/data/SchClass/";
		jqOptions3.colModel=[
			{'name':'id','hidden':true},
			{'name':'SchName','width':100,'label':'{%trans '时段名称' %}'},
			{'name':'StartTime','width':80,'label':'{%trans '上班时间' %}'},
			{'name':'EndTime','width':80,'label':'{%trans '下班时间' %}'}
		]
		jqOptions3.sortname="SchclassID";
		jqOptions3.sortorder="";
		jqOptions3.url=url
		jqOptions3.height=300
		jqOptions3.gridComplete=''
		jqOptions3.rowNum=500
		jqOptions3.rowList=[]
		
		jqOptions3.pager="#id_pager_schclass";
		renderGridData("schclass",jqOptions3)

}
function save_deptschedule_set()
{
	var deptid=getSelected_dept('showTree_'+g_activeTabID)
	var numrunids=getSelected_emp_ex('num_run')
	var schclassids=getSelected_emp_ex('schclass')
	var defaultnumrunid=$("#id_SaveNum_RUN").val()
	var queryStr="deptid="+deptid+"&num_runid="+numrunids+"&schclassid="+schclassids+"&defaultid="+defaultnumrunid;
	$.ajax({ type: "POST",
		url: "/iclock/att/save_deptschedule_set/",
		data:queryStr,
		dataType:"json",
		success: function(ret){
			$("#id_error_sec").css("display","block");
			$("#id_error_sec").html("<ul class='errorlist'><li>"+ret.message+"</li></ul>");
		},
		error: function(request, errorMsg){
			alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg));
		}
	});
	
	
}

//单位排班设置功能，暂时关闭
function deptschedule_set()
{
	
	var block_html="<div id=dlg_for_deptschedule_set  style='width:820px;height:480px;overflow:hidden;'>"
			+"<div id= dept_dept_tree class=dlgdiv style='width:240px;height:400px;overflow:hidden;'>"
				+"<ul id='showTree_"+g_activeTabID+"' class='ztree' style='margin-left: 0px;overflow:auto;height:350px;'></ul>"	
				+"<div id=id_error_sec></div>"
			+"</div>"
			+"<div id=dept_num_run class=dlgdiv style='width:450px;height:400px;'>"
				+"<div>选择该单位的员工可能用到的班次,对员工排班时,只有在这里选择了的班次才会出现,这样方便查找班次，提高排班效率：</div>"
				+"<table id='id_grid_num_run' >	</table>"
				+"<div id='id_pager_num_run'></div>"
				+"<div style='padding-top:10px;'>该单位新入职员工默认使用的班次:<input id='id_ShowNum_RUN' name='ShowNum_RUN' type='text' value='' readonly=true/><input id='id_SaveNum_RUN' name='SaveNum_RUN' type='hidden' value='0'/> <button id='id_delNumRun'>清除</button> </div>"
			+"</div>"
			+"<div id=dept_schclass class=dlgdiv style='width:360px;height:400px;'>"
				+"<div>选择该单位的员工可能用到的时段,对员工排班时,只有在这里选择了的时段才会出现,这样方便查找时段，提高排班效率：</div>"
				+"<table id='id_grid_schclass' >	</table>"
				+"<div id='id_pager_schclass'></div>"
			
			+"</div>"
			+"</div>"

			$(block_html).dialog({
						modal:true,
						resizable:false,
						width: 1100,
						height:520,
						title:'请首先选择单位 ',
						buttons:[{id:"btnShowOK",text:gettext("Submit"),click:function(){save_deptschedule_set();}},
							 {id:"btnShowCancel",text:gettext("Return"),click:function(){$(this).dialog("destroy"); }
							}],
						close:function(){$(this).dialog("destroy");}		

						})
	$("#dept_dept_tree").position({
		  my: "left top",
		  at: "left+10 top+10",
		  of: "#dlg_for_deptschedule_set"
		});
			
	$("#dept_num_run").position({
		  my: "left top",
		  at: "right+5 top",
		  of: "#dept_dept_tree"
		});
	$("#dept_schclass").position({
		  my: "right-10 top+10",
		  at: "right top",
		  of: "#dlg_for_deptschedule_set"
		});
	$("#id_delNumRun").click(function(){
		$('#id_ShowNum_RUN').val('')
		$('#id_SaveNum_RUN').val('')
		
	})
	ShowDeptData('schedule_set')
	get_Num_Run();
	get_SchClass();
	var zTree = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
	zTree.setting.check.enable = false;
	zTree.setting.callback.onClick = function onClick(e, treeId, treeNode){
		var deptID=treeNode.id;
		var deptName=treeNode.name;
		$('#dlg_for_deptschedule_set').dialog('option','title',deptName)
		$.post('/iclock/att/get_deptschedule_set/',
		       {deptid:deptID},
		function (data, textStatus) {
			$('#id_SaveNum_RUN').val(data.defaultid)
			$('#id_ShowNum_RUN').val(data.defaultname)
			$("#id_grid_num_run").jqGrid('resetSelection');
			$("#id_grid_schclass").jqGrid('resetSelection');
			for(var i=0;i<data.num_runid.length;i++)
				$("#id_grid_num_run").jqGrid('setSelection',data.num_runid[i]);
			for(var i=0;i<data.schclassid.length;i++)
				$("#id_grid_schclass").jqGrid('setSelection',data.schclassid[i]);
		},
		"json");
		
	}
	
 
}

function showWorkTime(uid,flag){
		var r=$("#id_grid_"+page_tab_user_of_run).jqGrid("getRowData",uid)
		var emp=uid
		var empName=r.username
		var empPin=r.badgenumber
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
		var isError=validate_form_user_of_run(0,uid);
		//$("#id_addsch_tmpShift").attr("disabled","disabled");
		//$("#isTmporary").val(0)
		if(isError)
		{	
			//$("#id_error").css("display","block");
			alert("{%trans 'Please check that you select one or more employees and the date is validate!'%}");
		}
		else{	
			var cTime=ComeTime.split("-");
			var days=validate_date(ComeTime,EndDate)+1;
			var cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
			$("#id_error").css("display","none");
			$.cookie("ComeTime_"+page_tab_user_of_run,ComeTime, { expires: 7 });
			$.cookie("EndDate_"+page_tab_user_of_run,EndDate, { expires: 7 });
			var queryStr="ComeTime="+ComeTime+"&EndDate="+EndDate+"&UserID="+emp;
			
			var block_html="<div id='id_shift_details' ><fieldset style='border:1px solid #77B7DE;'><legend>{%trans 'Employee shift details' %}</legend><div id='id_shift_details_h' style='height:350px;width:960px;overflow:auto;'>"
			+"<div id='tz'>"
			+"</div></div></fieldset>"
			+"</div>"
			
		$(block_html).dialog({modal:true,
			resizable:false,
			width: 980,
			height:450,
			maxWidth:1024,
			dialogClass: "no-close",
			title:'',
			buttons:[
			    {id:"btnCancel",text:'{%trans "Return" %}',click:function(){$(this).dialog("destroy"); }}
			]
			
			
		});
			
			
		if(flag!=1)	
		{	
			$.ajax({ 
				type: "POST",
				url:"/iclock/att/worktimezone/",
				data:queryStr,
				dataType:"json",
				success:function(data){
					$("#id_shift_details fieldset legend").html("<b><font size='2'>{%trans 'Employee shift details' %}("+empName+"["+empPin+"])</font></b>");
					$("#tz").html(createTZTable(data,getTZDateLabel,days,cdate));
				//var isTemp=$("#isTmporary").val();
				//if(isTemp=="1"){
					$(".tzbar").dblclick(function(){
						var start=$(this).attr("alt2");
						var end=$(this).attr("alt2");
						var schClassId=$(this).attr("alt4");
						if(start!=undefined&&end!=undefined){
							ret=window.confirm(gettext("Are you sure delete the shift?"));
							if(ret)
							{
								$(this).addClass("tzbar space");
								$(this).css("background-color","");
								$(this).html("");
								var queryStr="StartDate="+start+"&EndDate="+end+"&UserIDs="+emp+"&sTimeTbl="+schClassId+"&sDates=";
							  $.ajax({ type: "POST",
										url: "/iclock/att/deleteEmployeeShift/",
										data:queryStr,
										dataType:"json",
										success: function(ret){delEmpShift_success(ret,[emp,empName,empPin])},
										error: function(request, errorMsg){
										   alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg)); 
										   }
								   });
						
							 
							}
						}
					});
				}
				//}
            
			
			});
		}
		else
		{

			$.ajax({ 
				type: "POST",
				url:"/iclock/att/worktimezone/?flag="+flag+'&userid='+emp,
				data:queryStr,
				dataType:"json",
				success:function(data){
					$("#id_shift_details fieldset legend").html("<b><font size='2'>{%trans '排班原始数据' %}</font></b>");
					$("#tz").html(data.message);
				}
			});



		 
		}
            
		}	
	}

function actionSucess_NoReload(retdata,datalist)
{
    reloadShiftData(page_tab_user_of_run)
	if(retdata.ret==0){
		if (datalist!=undefined&&datalist.length>0){
			var emp=empNames=empPin=[]
			emp[0]=datalist[0]
			empNames[0]=datalist[1]
			empPin[0]=datalist[2]
		}else{
			var emp=getSelected_emp_ex(page_tab_user_of_run);
			var empNames=getSelected_empNames_ex(page_tab_user_of_run);
			var empPin=getSelected_empPin_ex(page_tab_user_of_run);
		}
		var ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
		var EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
		var cTime=ComeTime.split("-");
		var	cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
		var days=validate_date(ComeTime,EndDate)+1;
		if(emp.length>0){
			var queryStr="ComeTime="+ComeTime+"&EndDate="+EndDate+"&UserID="+emp[0]+"&sDates=";
			$.ajax({ 
				type: "POST",
				url:"/iclock/att/worktimezone/",
				data:queryStr,
				dataType:"json",
				success:function(json){
					$("#id_shift_details fieldset legend").html("<b><font size='2'>{%trans 'Employee shift details' %}("+empNames[0]+"["+empPin[0]+"])</font></b>");
					$("#tz").html(createTZTable(json,getTZDateLabel,days,cdate));
					var isTemp=$("#isTmporary").val();
					if(isTemp=="1"){
						$(".tzbar").dblclick(function(){
						var start=$(this).attr("alt2");
						var end=$(this).attr("alt2");
						var schClassId=$(this).attr("alt4");
						if(start!=undefined&&end!=undefined){
			   if(start!=undefined&&end!=undefined&&options[g_activeTabID].canEdit)
			   {
			     ret=window.confirm(gettext("Are you sure delete the shift?"));
			     if(ret)
			     {   
				 var queryStr="StartDate="+start+"&EndDate="+end+"&UserIDs="+emp[0]+"&sTimeTbl="+schClassId+"&sDates=";
				 $.ajax({ type: "POST",
					 url: "/iclock/att/deleteEmployeeShift/",
					 data:queryStr,
					 dataType:"json",
					 success: function(ret){delEmpShift_success(ret,datalist)},
					 error: function(request, errorMsg){
					    alert($.validator.format(gettext('Operating failed for {0} : {1}'), options[g_activeTabID].title, errorMsg)); 
					    }
				    });
			     }
			   
			   }
			   
                       }
                    });
				}
				}
			});
		}
		else
		{
			$("#tz").html("");
			$("#id_error").css("display","block");
			$("#id_error").html("<ul class='errorlist'><li>{%trans 'By Department to shift have been successed!Please select one employee to show the shift detail!'%}</li></ul>");
		}
	}
	else if(retdata.ret==1)
	{
		$.unblockUI();
		$("#id_error").css("display","block");
		$("#id_error").html("<ul class='errorlist'><li>该时段和已有时段重合或者间隔时间太小</li></ul>");
		
	}
	else if(retdata.ret==2)
	{
		$.unblockUI();
		$("#id_addsch_tmpShift").attr("disabled","disabled");
		$("#id_error").css("display","block");
		$("#id_error").html("<ul class='errorlist'><li>{%trans 'Save Fail,account has been locked!'%}</li></ul>");
	}

	else
	{
		alert(retdata.message);
	}

}


function saveEmpShift_success(retdata)
{
	if(retdata.ret==0){

	}
	else if(retdata.ret==1)
	{
		$("#id_error_sec").css("display","block");
		$("#id_error_sec").html("<ul class='errorlist'><li>该时段和已有时段重合或者间隔时间太小</li></ul>");
		
	}
	else if(retdata.ret==2)
	{
		$("#id_error_sec").css("display","block");
		$("#id_error_sec").html("<ul class='errorlist'><li>{%trans 'Save Fail,account has been locked!'%}</li></ul>");
	}

	else
	{
		alert(retdata.message);
	}

}

function delEmpShift_success(retdata,datalist)
{   
    if(retdata.ret==0){
		$("#isTmporary").val(1)
		actionSucess_NoReload(retdata,datalist)
	}
	else
	{
		alert(retdata.message);
	}
}

function showDefalutAuto()
{
	$("#selected_count_schClass").html("" + MayUsedAutoIds.length);
	$("#id_least_days").val(parseInt(MinAutoPlanInterval/24));
	$("#id_least_hours").val(MinAutoPlanInterval%24);
	for(var i=0;i<MayUsedAutoIds.length;i++)
	{
		$.each($(".class_select_schClass"),function(){
			if($(this).attr("alt")==MayUsedAutoIds[i])
				$(this).attr("checked","checked");		   
		});
		
	}
	if(AutoSchPlan==1){
		$("#id_auto_assign").prop("checked","checked");
	}
	else{
		$("#id_auto_assign").removeAttr("checked");
		$("#id_least_days").attr("disabled","disabled");
		$("#id_least_hours").attr("disabled","disabled");
		$(".class_select_schClass").attr("disabled","disabled");
		$("#is_select_all_shcClass").attr("disabled","disabled");
	}
	
}
//重复班次不增加判断
function is_ready_add(shift_id,startDate,endDate)
{
	for(var i=0;i<assignedShifts.length;i++)
		if(assignedShifts[i].SchId==shift_id &&assignedShifts[i].StartDate==startDate && assignedShifts[i].EndDate==endDate)
			{return 1;break;}
	return 0;		
		
}

//时间有效性验证 开始日期要小于结束日期
function validate_date(ComeTime,EndDate)
{
	var cTime=ComeTime.split("-");
	var eTime=EndDate.split("-");
	var cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
	var edate=new Date(parseInt(eTime[0],10),parseInt(eTime[1],10)-1,parseInt(eTime[2],10));
	var days=(edate.valueOf()-cdate.valueOf())/(1000*3600*24);
	return days;
}
function validate_form_user_of_run(flag,userid){   //验证表单的合法性(人员(可不选，在计算项目中计算选中单位的人员，其他的就默认值0)、开始时间、结束时间)
	var t_emp=userid	
	if (typeof(userid)=='undefined')	
		t_emp=getSelected_emp_ex(page_tab_user_of_run);
	
	//var deptIDs=$("#show_dept_emp_tree").find("#hidden_selDept").val
	
		var treeObj = $.fn.zTree.getZTreeObj("showTree_"+g_activeTabID);
		var nodes = treeObj.getSelectedNodes();
		var deptIDs='';
		var deptName=''
		if (nodes.length>0)
		{
		    deptIDs=nodes[0].id
		    deptName=nodes[0].name;
		}
	
	
	var t_ComeTime=$("#id_ComeTime_"+page_tab_user_of_run).val();
	var cTime=t_ComeTime.split("-");
	var t_EndDate=$("#id_EndTime_"+page_tab_user_of_run).val();
	var eTime=t_EndDate.split("-");
	var cdate=new Date(parseInt(cTime[0],10),parseInt(cTime[1],10)-1,parseInt(cTime[2],10));
	var edate=new Date(parseInt(eTime[0],10),parseInt(eTime[1],10)-1,parseInt(eTime[2],10));
	var days=(edate.valueOf()-cdate.valueOf())/(1000*3600*24)+1;
	if(flag==0){
		if(t_ComeTime=="" || t_EndDate=="" || cdate>edate ||t_emp.length==0||!valiDate(t_ComeTime)||!valiDate(t_EndDate))
			return 1;
		else
			return 0
	}
	else{
		if((t_ComeTime=="" || t_EndDate=="" ||(t_emp.length==0&&deptIDs=="")|| cdate>edate ||!valiDate(t_ComeTime)||!valiDate(t_EndDate)))
			return 1;
		else
			return 0
	}
}


function get_assignedShifts_String(lc)  //构造字典字符串
{
	var result = "["
	if(lc.length>0){
		for(var i=0; i <lc.length; i++){ 
			row = lc[i];
			row_string = "{";
			for (var j in row){
				if(j=="SchName"||j=="StartDate"||j=="EndDate")
					row_string += "\""+j + "\":\""+  row[j] + "\",";
				else 
					row_string += "\""+j + "\":"  +  row[j] + ",";
				}
			row_string = row_string.substring(0, row_string.length-1)+"}";
		result += row_string + ",";
		}
		result = result.substring(0, result.length-1);
	}
	result+="]";
	return result;
}

//删除已排班次
function del_assigned_shifts()
{
	var shift_ids=getSelected_assigned();
	if(shift_ids.length>0){
		for(var i=0;i<assignedShifts.length;i++){
			for(var j=0;j<shift_ids.length;j++){
				if(assignedShifts[i].numID==shift_ids[j]){
					assignedShifts.splice(i,1);
				}
			}
		}
	getAssignedShifts_html();
	}
}

function getAssignedShifts_html()   //显示当前排的班次
{
	var html="<table><tr><th><input type='checkbox' id='is_select_all_assigned' checked onclick='check_all_for_row_assigned(this.checked);' /></th><th>{% trans 'Sch name'%}</th><th>{% trans 'StartDate'%}</th><th>{% trans 'EndDate'%}</th></tr>";
	
	if(assignedShifts.length>0){
		for(var i=0;i<assignedShifts.length;i++)
			html+="<tr><td><input type='checkbox' class='class_select_assigned'  alt='"+assignedShifts[i].numID+"' onclick='showSelected_assigned();' checked/></td><td>"+assignedShifts[i].SchName+"</td><td>"+assignedShifts[i].StartDate+"</td><td>&nbsp;"+assignedShifts[i].EndDate+"</td></tr>";
	html+='<tr><td colspan="4">'
	+'<div id="select_div">'
	+'({% trans "Selected:" %} <span id="selected_count_assigned">'+assignedShifts.length+'</span>)</div></td></tr>'
	}
	html+="</table>"
	$("#id_assigned_shifts").html(html);
}

//选择已排班次
function showSelected_assigned() {
    var c = 0;
    $.each($(".class_select_assigned"),function(){
			if(this.checked) c+=1;})
    $("#selected_count_assigned").html("" + c);
}
function check_all_for_row_assigned(checked) 
{
	if (checked) {
        $(".class_select_assigned").attr("checked", "true");
    } else {
        $(".class_select_assigned").removeAttr("checked");
    }
    showSelected_assigned();
}
function getSelected_assigned()
{
    var assigned_shifts=[];
    $.each($(".class_select_assigned"),function(){
            if(this.checked) {
                assigned_shifts.push(this.alt)}
    });
    return assigned_shifts;
}

//选择日期
function showSelected_dates() {
    var c = 0;
	$("#is_select_all_dates").removeAttr("checked");
    $.each($(".class_select_dates"),function(){
			if(this.checked) c+=1;})
    $("#selected_count_dates").html("" + c);
}
function check_all_for_row_dates(checked) {

    if (checked) {
        $(".class_select_dates").attr("checked", "true");
    } else {
        $(".class_select_dates").removeAttr("checked");
    }
    showSelected_dates();
}
function getSelected_Dates()
{
    var sdates=[];
    $.each($(".class_select_dates"),function(){
            if(this.checked) 
                sdates.push(this.alt)
    });
    return sdates;
}

//选择时段

function showSelected_SchClass() {
	if (!$(".class_select_schClass").checked) {  
        $("#is_select_all_shcClass").prop("checked", false);  
    }
	var chsub = $("input[type='checkbox'][name='box']").length; 
	var checkedsub = $("input[type='checkbox'][name='box']:checked").length; 
	if (checkedsub == chsub){ 
		$("#is_select_all_shcClass").prop("checked", true); 
	}
    var c = 0;
    $.each($(".class_select_schClass"),function(){
			if(this.checked) c+=1;})
    $("#selected_count_schClass").html("" + c);
}
function check_all_for_row_SchClass(checked) {

	if ($("#is_select_all_shcClass").prop("checked")){ 
		$("input[name='box']").prop("checked",true);
	}else{ 
		$("input[name='box']").prop("checked",false); 
	}
	showSelected_SchClass();
}
function getSelected_SchClass()
{
	var sSchClass=[]
	$.each($(".class_select_schClass"),function(){
		   if(this.checked) 
			   sSchClass.push(this.alt)
   });
   return sSchClass;
}
function isExistsNumRunOrSchclass(itype,id)
{
	if(itype==1)
	{
		if (dept_schedule_set.num_runid.length==0) return true;
		for(var i=0;i<dept_schedule_set.num_runid.length;i++)
		if (id==dept_schedule_set.num_runid[i]) return true;
	}
	else if (itype==2)
	{
		if (dept_schedule_set.schclassid.length==0) return true;
		for(var i=0;i<dept_schedule_set.schclassid.length;i++)
		if (id==dept_schedule_set.schclassid[i]) return true;
	}
	return false;	
	
	
}
//得到班次列表
function getShifts_html()
{
	
	var options_html="";
	var j=0
	for(var i=0;i<shifts.length;i++)
	{
		//if (isExistsNumRunOrSchclass(1,shifts[i].shift_id))
		//{
			if(j==0)
				options_html+="<option value='"+shifts[i].shift_id+"' name='"+shifts[i].shift_name+"' selected>"+shifts[i].shift_name+"</option>"
			else
				options_html+="<option value='"+shifts[i].shift_id+"' name='"+shifts[i].shift_name+"'>"+shifts[i].shift_name+"</option>"
			j=j+1
		//}
	}
	return options_html;
}
//显示班次详情
function showshift(sid){
	/*
	$("#id_Shift_Detail_dlg").remove();
	var html="<div id='id_Shift_Detail_dlg' style='overflow: auto; height: 190px;width:990px; margin-left:10px'>"
			+"<fieldset><legend></legend>"
			+"<div style='overflow: auto; height: 150px; width:960px;'>"
			+"<div id='tz_dlg'></div></div></fieldset></div>"
			+"<div id='id_numrun_tip' class='numrun_tip' style='margin-left:15px；dsiplay:none'></div>"
	$("#dlg_btn").after(html)
	*/
    if(sid){
        $.ajax({ 
            type: "POST",
            url:"/iclock/att/getData/?func=NUM_RUN&numrunid="+sid,
            dataType:"json",
            success:function(json){
                if(json.h_unit==0){
                    json.Units='天'
                }else if (json.h_unit==1){
                    json.Units='周'
                }else if (json.h_unit==2){
                    json.Units='月'	
                }
                var rowData=[json.Num_runID,json.Name,json.StartDate,json.EndDate,json.Cycle,json.Units,json.h_unit]
				ii = 1
                show_shift_Detail(rowData,0,ii)
        }}) 
	}
}
function getTZWeekLabel(index)
{  
    index+=parseInt(weekStartDay); 
	return ["{% trans 'Sunday' %}","{% trans 'Monday' %}","{% trans 'Tuesday' %}","{% trans 'Wednesday' %}","{% trans 'Thursday' %}","{% trans 'Friday' %}","{% trans 'Saturday' %}"][index % 7];
}
function getTZDayLabel(index)
{
	return "第 "+(index+1)+" 天"
}


var week=[
		"{% trans 'Sunday' %}",
	     "{% trans 'Monday' %}",
	     "{% trans 'Tuesday' %}",
	     "{% trans 'Wednesday' %}",
	     "{% trans 'Thursday' %}",
	     "{% trans 'Friday' %}",
	     "{% trans 'Saturday' %}"
];


//得到时段列表
function getSchClass_html_user_of_run(){
	var html="<tr><td>"
       +"<div id='select_div'>"
	   +"<input type='checkbox' id='is_select_all_shcClass' name='allbox' onclick='check_all_for_row_SchClass(this.checked);' />"
       +"({%trans 'Selected:'%} <span id='selected_count_schClass'>0</span>)"
   +"</td></tr>";
	for(i=0;i<schClass_uor.length;i++)
		//if (isExistsNumRunOrSchclass(2,schClass_uor[i].SchclassID))
		html+="<tr><td><input type='checkbox' name='box' class='class_select_schClass' alt='"+schClass_uor[i].SchclassID+"' onclick='showSelected_SchClass();' />"+schClass_uor[i].SchName+"("+schClass_uor[i].StartTime.substr(0,5)+"-"+schClass_uor[i].EndTime.substr(0,5)+")</td></tr>"
	return html;
}

//得到时段列表临时排班
function getSchClass_html_tmp(){
	var html=""
	for(i=0;i<schClass_uor.length;i++)
		//if (isExistsNumRunOrSchclass(2,schClass_uor[i].SchclassID))
		html+="<tr><td><a class='class_select_schClass' alt='"+schClass_uor[i].SchclassID+"' alt1='"+schClass_uor[i].SchName+"'>"+schClass_uor[i].SchName+"("+schClass_uor[i].StartTime.substr(0,5)+"-"+schClass_uor[i].EndTime.substr(0,5)+")</a></td></tr>"
	return html;
}

function getSchClass_day_tmp(){
	var html=""
	for(i=0;i<schClass_uor.length;i++)
		//if (isExistsNumRunOrSchclass(2,schClass_uor[i].SchclassID))
		html+="<tr><td><input type='checkbox' alt='"+schClass_uor[i].SchclassID+"' name='"+schClass_uor[i].SchName+"' class='class_select_shift'></td><td>"+schClass_uor[i].SchName+"("+schClass_uor[i].StartTime.substr(0,5)+"-"+schClass_uor[i].EndTime.substr(0,5)+")</a></td></tr>"
	return html;
}

//得到日期列表
function getDates_html(cdate,days)
{	var dates_html="<tr><td>"
       +"<div id='select_div'>"
       +"<input type='checkbox' id='is_select_all_dates' onclick='check_all_for_row_dates(this.checked);' checked/>"
       +"({%trans 'Selected:'%} <span id='selected_count_dates'>"+days+"</span>)"
   +"</td></tr>";

	for(var i=0;i<days;i++)
	{
		var tmp=new Date(cdate.valueOf()+i*1000*3600*24);
		var m="00"+(tmp.getMonth()+1);
		var d="00"+tmp.getDate();
		dates_html+="<tr><td><input type='checkbox' class='class_select_dates' alt='"+tmp.year()+"-"+m.substring(m.length-2)+"-"+d.substring(d.length-2)+"'  onclick='showSelected_dates();' checked/>"
					+m.substring(m.length-2)+"-"+d.substring(d.length-2)+" "+week[tmp.getDay()]
					+"</td></tr>";
	}
	return dates_html;
}

function getTZDateLabel(index,sdate)
{
	var tmp=new Date(sdate.valueOf()+index*1000*3600*24);
	var m="00"+(tmp.getMonth()+1);
	var d="00"+tmp.getDate();
	return	m.substring(m.length-2)+"-"+d.substring(d.length-2)+" "+week[tmp.getDay()];
}

//人员排班查询
function searchShowEmp_user_of_run(){
	var flag=$("#"+g_activeTabID+" #searchbar_user_of_run").attr('role');
	if (flag!='cansearch'&&flag!='defvalue') return;
	if (flag!='defvalue')
		var v=$("#"+g_activeTabID+" #searchbar_user_of_run")[0].value;
	else
		var v=""
    //var v=$("#searchbar_user_of_run").val();
    //if (v=='') return;
    var deptids=getSelected_dept("showTree_"+g_activeTabID);
    var ComeTime=$("#id_ComeTime_user_of_run").val();
    var EndDate=$("#id_EndTime_user_of_run").val();
    if(ComeTime>EndDate){
        alert('开始时间不能大于结束时间')
        return
    }
    var urlStr="/iclock/att/searchComposite/?flag=shift3"
     urlStr=urlStr+"&startDate="+ComeTime+"&endDate="+EndDate
    if(deptids.length>0){
	var deptID=deptids[0]
	var ischecked=0;
	if($("#id_cascadecheck_tab_iclock_USER_OF_RUN").prop("checked"))
		ischecked=1;
	urlStr=urlStr+"&deptIDs="+deptID+"&isContainChild="+ischecked
    }
    var url=urlStr+"&q="+escape(v);
		//var url="/iclock/att/searchComposite/?flag=shift3&deptIDs="+deptID+"&isContainChild="+ischecked+"&q="+v
    savecookie("search_urlstr",url);
    $("#id_grid_user_of_run").jqGrid('setGridParam',{url:url,datatype:"json"}).trigger("reloadGrid");
    
}
function createQueryDlg_USER_OF_RUN(){
	createDlgdeptfor10('employee_search',1)
	$('#dlg_for_query_employee_search').dialog({
	buttons:[{id:"btnShowOK",text:gettext('搜索'),
	  click:function(){searchbydept_USER_OF_RUN('employee_search');$(this).dialog("destroy"); }},
	 {id:"btnShowCancel",text:gettext('Return'),click:function(){$(this).dialog("destroy"); }
	}] })
}

function searchbydept_USER_OF_RUN(page){
    var ComeTime=$("#id_ComeTime_user_of_run").val();
    var EndDate=$("#id_EndTime_user_of_run").val();
    
    var urlStr="/iclock/att/searchComposite/?flag=shift3"	
     urlStr=urlStr+"&startDate="+ComeTime+"&endDate="+EndDate
    var emp=getSelected_emp_ex("sel_employee_search");
    if(emp.length>0){
	urlStr+="&UserID__in="+emp
    }
	savecookie("search_urlstr",urlStr);
    $("#id_grid_user_of_run").jqGrid('setGridParam',{url:urlStr,datatype:"json"}).trigger("reloadGrid");
 /*
    $.post('/iclock/att/get_deptschedule_set/',
		       {deptid:dept_ids},
		function (data, textStatus) {
			dept_schedule_set=data;

		},
		"json");
		*/
}
/**		//正常排班查询
function shiftSearchShowEmp(){
    var v=$("#searchbar_"+page_tab_user_of_run).val();
    if (v=='') return;
    var url="/iclock/data/USER_OF_RUN/?t=empOfShifts.js&q="+escape(v)
    savecookie("search_urlstr",url);
    $("#id_"+page_tab_user_of_run+"grid").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
}
//临时排班查询
function TempSearchShowEmp(){
    var v=$("#searchbar_"+page_tab_user_of_run).val();
    if (v=='') return;
    var url="/iclock/data/USER_TEMP_SCH/?t=empOftmpShifts.js&q="+escape(v)
    savecookie("search_urlstr",url);
    $("#id_"+page_tab_user_of_run+"grid").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
}
//综合排班查询
function CompositeSearchShowEmp(){
    var v=$("#searchbar_"+page_tab_user_of_run).val();
    var deptIDs=$("#show_dept_emp_tree_"+page_tab_user_of_run).find("#hidden_selDept").val()
	var ischecked=0;
	if($("#id_contain_chl_"+page_tab_user_of_run).prop("checked"))
		ischecked=1;
    if (v=='') return;
    var url="/iclock/att/searchComposite/?flag=shift2&isContainChild="+ischecked+"&q="+escape(v)+"&deptIDs="+deptIDs+"&startDate="+$("#id_ComeTime_"+page_tab_user_of_run).val()+"&endDate="+$("#id_EndTime_"+page_tab_user_of_run).val()
    savecookie("search_urlstr",url);
    $("#id_"+page_tab_user_of_run+"grid").jqGrid('setGridParam',{url:url}).trigger("reloadGrid");
}**/


</script>

<div id="id_top">
	<div class="sear-box quick-sear-box" >
		
		{% ifequal "opt_users_start_page"|get_params:request '1' %}
	      
		      <div id='id_add_home'  onclick="javascript:saveHome();"  style="float: left;cursor:pointer;"> <i class="icon iconfont icon-shezhiweiqishiye" title='{%trans "设置为起始页" %}'></i></div>
		 {%endifequal%}	
		
		
		
		<div class="s-info left" id="time_area">		
                                 <span>
                                       <label  >{%trans 'Begin Date'%}</label>
                                        <input type='text' name='ComeTime' maxlength='10' id='id_ComeTime_user_of_run' style='width:80px !important;'>
                                        <label  >{%trans 'End Date'%}</label>
                                        <input type='text' name='EndTime' maxlength='10' id='id_EndTime_user_of_run' style='width:80px !important;'>
       
                                </span>
                                
                 </div>

		
		<div class="s-info right" id="sear_area">			
			<div class="nui-ipt nui-ipt-hasIconBtn " >
				<input id="searchbar_user_of_run" class="search-input" type="text"  value="考勤编号,身份证号，姓名" role='defvalue' autocomplete="off" />
				<span id ="queryButton" class="nui-ipt-iconBtn">
					<b id="_icon_2_28" class="nui-ico nui-ico-dArr "></b>
				</span>
				
			</div>
			
			<div class="main-search-btn">
			
				<span id="searchButton" class="chaxun icon iconfont icon-chaxun"> </span>
			</div>
		</div>
	</div>
		<div id="id_toolbar">	
			<UL class="toolbar" id="navi">
				<LI id="id_reload"><SPAN class="icon iconfont icon-shuaxin"></SPAN>{%trans "Reload"%}</LI>
				{% if request|reqHasPerm:"add" %}
				 <LI id="btn-schedule"onclick="add_empShift();"><SPAN class='icon iconfont icon-zhouqipaiban'></SPAN>{%trans "周期排班"%}</LI>
			
				<LI id="btn-addschclass"onclick="addsch_tmpShift();"><SPAN  class='icon iconfont icon-lingshipaiban'></SPAN>{%trans "临时排班"%}</LI>
				<LI id="btn-impschclass"  onclick="importschclass_tmpShift();"><SPAN class= 'icon iconfont icon-daoru'></SPAN>{%trans "导入排班"%}</LI>
				{% endif %}

				{% if request|reqHasPerm:"delete" %}
				<LI id="btn-clearAllschclass"  onclick="clearall_tmpShift('shifts');"><SPAN class="icon iconfont icon-shanchu"></SPAN>{%trans "清除排班"%}</LI>
				{% endif %}
				
			</UL>
			
		
	      </div>
	

	
</div>
<input type='text' style='display:none;' value='0' id='isTmporary' />

<div class="module" style="width: 99%;;padding-top: 3px;">
	
	<table id="id_grid_user_of_run" >	</table>
	<div id="id_pager_user_of_run"></div>
	 
</div>
<div>
    <br>
    <p>1.如果仅选择单位(不选择人员)时，系统将对该单位下的所有人员进行排班  2.对于有规律上班的人员请先设置好班次然后进行周期排班,否则使用临时排班功能 </p> <p>3.清除排班是清除指定时间的所有排班  4.在排班详情时段条上双击可删除所排的时段</p>
		<!--<span id='id_error' style='float:right;'></span>-->
	
</div>
