/********************读卡：判断读卡方式是否正确****************/var ISSOnlineurl="http://127.0.0.1:24008/ISSOnline/ZKPosHelper?",key="";function ic_comm(b,a){var c=ISSOnlineurl+"CardSender\x3dCR10MW\x26DATA\x3d"+b+"\x26SESSION\x3d"+a;jQuery.support.cors=!0;$.ajax({type:"GET",url:c,async:!1,data:"",dataType:"json",success:function(a){result=a},error:function(a,b){result={ret:-1};alert(gettext("\u8bf7\u5b89\u88c5\u9a71\u52a8\u6216\u542f\u52a8\u8be5\u670d\u52a1!"));$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8bf7\u5b89\u88c5\u9a71\u52a8\u6216\u542f\u52a8\u8be5\u670d\u52a1\uff01\x3c/li\x3e\x3c/ul\x3e').show()}});return result}function ZK_PosReadICCard(b,a,c,d){cmdStr="CMD\x3d3\x26Key\x3d"+CharToHex(a)+"\x26MainSec\x3d"+c+"\x26BackSec\x3d"+d+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);if((result=ic_comm(data,sessionid))&&0==result.ret){ret_data="";for(var e in result.data)ret_data&&(ret_data+=","),ret_data+=e+"\x3d"+result.data[e];return ret_data}return""}function ZK_PosWriteICCardPassword(b,a,c,d,e){cmdStr="CMD\x3d5\x26OldKey\x3d"+CharToHex(a)+"\x26NewKey\x3d"+CharToHex(c)+"\x26MainSec\x3d"+d+"\x26BackSec\x3d"+e+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);result=ic_comm(data,sessionid);return result.ret}function ZK_PosClearICCard(b,a,c,d){cmdStr="CMD\x3d2\x26Key\x3d"+CharToHex(a)+"\x26MainSec\x3d"+c+"\x26BackSec\x3d"+d+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);result=ic_comm(data,sessionid);return result.ret}function ZK_PosIssueICCard(b,a,c,d,e,f,g,h,k){cmdStr="CMD\x3d1\x26Key\x3d"+CharToHex(a)+"\x26OverPwd\x3d"+c+"\x26CardNo\x3d"+d+"\x26Money\x3d"+e+"\x26CardType\x3d"+f+"\x26StartDate\x3d"+moment().format("YYYYMMDD")+"\x26MainSec\x3d"+h+"\x26BackSec\x3d"+k+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);result=ic_comm(data,sessionid);return result.ret}function ZK_PosUpdateParam(b,a,c,d,e,f,g){d=d.replace(/-/g,"");cmdStr="CMD\x3d6\x26Key\x3d"+CharToHex(a)+"\x26OverPwd\x3d"+c+"\x26Issuedate\x3d"+d+"\x26MainSec\x3d"+f+"\x26BackSec\x3d"+g+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);result=ic_comm(data,sessionid);return result.ret}function ZK_PosWriteICCardMoney(b,a,c,d,e){cmdStr="CMD\x3d4\x26Key\x3d"+CharToHex(a)+"\x26Money\x3d"+c+"\x26MainSec\x3d"+d+"\x26BackSec\x3d"+e+"\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);result=ic_comm(data,sessionid);return result.ret}function clearNoNum(b){b.bind("onkeyup",function(){b.value=b.value.replace(/[^\d.]/g,"");b.value=b.value.replace(/^\./g,"");b.value=b.value.replace(/\.{2,}/g,".");b.value=b.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".")})}function readCardSleep(){}function readCard(){cmdStr="CMD\x3d7\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);if(result=ic_comm(data,sessionid))if(0==result.ret){if(CardNo=result.data.toString(),5<CardNo.length)return CardNo}else return result.ret;return"999"}function check_card(b){switch(b.toString()){case "999":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5361\u53f7\u4e0d\u4e00\u81f4,\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e').show(),!1;case "-2":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u4e3b\u5907\u6247\u533a\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u8be5\u5361\u7247\u9700\u8981\u5728\u6d88\u8d39\u673a\u4e0a\u5237\u4e00\u6b21\u540e\uff0c\u624d\u80fd\u6b63\u5e38\u4f7f\u7528\x3c/li\x3e\x3c/ul\x3e').show(),!1;case "131":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u6ca1\u6709\u627e\u5230IC\u5361\u6216\u8005\u5361\u662f\u5426\u635f\u574f\x3c/li\x3e\x3c/ul\x3e').show(),!1;case "140":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u6247\u533a\u5bc6\u7801\u9519\u8bef\x3c/li\x3e\x3c/ul\x3e').show(),!1;case "5":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8bf7\u8fde\u63a5\u8bfb\u5361\u5668\x3c/li\x3e\x3c/ul\x3e').show(),!1;case "-1":return $("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u4f20\u5165\u53c2\u6570\u9519\u8bef\x3c/li\x3e\x3c/ul\x3e').show(),!1}}function stringToBytes(b){for(var a,c,d=[],e=0;e<b.length;e++){a=b.charCodeAt(e).toString(16);c=[];do c.push(a&255),a>>=8;while(a);d=d.concat(c.reverse())}return d}function isEmptyCard(){var b=ZK_PosReadICCard(0,sys_pwd,main_fan,minor_fan),a=b.split(","),c=!1;if(1<a.length){for(i=0;2>i;i++)if(0==a[i].split("\x3d")[1]&&0==a[4].split("\x3d")[1]&&0==a[6].split("\x3d")[1])c=!0;else{c=!1;break}return c}return b}function isOnline(b){if(b&&1==b)return!0;t=5;cmdStr="CMD\x3d7\x26DCCK\x3d**\x26DLK\x3d**\x26DPK\x3d**\x26DULK\x3d**\x26UserData\x3d**";sessionid=$.now();data=zk_encrypt(cmdStr,sessionid);if(result=ic_comm(data,sessionid))t=result.ret;t=parseInt(t);if(0>t)-3010==t?$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8bf7\u5728\u7cfb\u7edf\u9009\u9879-\u6d88\u8d39\u53c2\u6570\u8bbe\u7f6e\u754c\u9762\u4e0b\u8f7d\u8bc1\u4e66\uff0c\u5e76\u5c06\u8bc1\u4e66\u6587\u4ef6\u590d\u5236\u5230c:\\\x3c/li\x3e\x3c/ul\x3e'):$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u53c2\u6570\u65e0\u6548\x3c/li\x3e\x3c/ul\x3e');else{if("5"!=t)return $("#read_card").removeProp("disabled",""),!0;$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8bf7\u8fde\u63a5\u53d1\u5361\u5668\x3c/li\x3e\x3c/ul\x3e')}return!1}function writeICMoney(b,a,c,d,e,f){return ZK_PosWriteICCardMoney(b,a,c,e,f)}function isvild_write_card(b,a,c,d){return!0}function isvild_write_Add_card(b,a,c,d){return!0}function funValidCard(){var b=$("#id_edit_form_consume").formSerialize(),a=!1;$.ajax({type:"POST",url:"/ipos/valid_card/",data:b,dataType:"json",cache:!1,async:!1,success:function(b){switch(b.ret){case "OK":a=!0;break;case "PRIVAGE_CARD":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u7ba1\u7406\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_STOP":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u505c\u7528\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_LOST":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u6302\u5931\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "Not_REGISTER_CARD":$("#id_error").append('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u6ca1\u6709\u767b\u8bb0\u5361\u8d26\u53f7\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_OVERDUE_VALID":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8bf7\u5148\u6302\u5931\u5361\u7247\uff0c\u64cd\u4f5c\u5931\u8d25\x3c/li\x3e\x3c/ul\x3e'),a=!1}}});return a}function page_valid(b,a){val_tag=!1;switch(b){case "1":val_tag=!0;break;case "3":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u6302\u5931\u5361\uff0c\u4e0d\u5141\u8bb8\u64cd\u4f5c\uff01\x3c/li\x3e\x3c/ul\x3e');val_tag=!1;break;case "5":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u505c\u7528\u5361\uff0c\u4e0d\u5141\u8bb8\u64cd\u4f5c\uff01\x3c/li\x3e\x3c/ul\x3e');val_tag=!1;break;case "4":"1"==a?($("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u8fc7\u671f\u5361\uff0c\u4e0d\u5141\u8bb8\u64cd\u4f5c\uff01\x3c/li\x3e\x3c/ul\x3e'),val_tag=!1):val_tag=!0}return val_tag}function funSaveBakData(b){var a=!1;b=b?b.formSerialize():$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/save_operate_bak_data/",data:b,dataType:"json",cache:!1,async:!1,success:function(b){switch(b.ret){case "OK":a=!0;break;case "FAIL":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u7cfb\u7edf\u51fa\u9519\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "PRIVAGE_CARD":$("#error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u7ba1\u7406\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_LOST":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u6302\u5931\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_STOP":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u505c\u7528\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_OVERDUE":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u64cd\u4f5c\u5361\u7247\u4e3a\u8fc7\u671f\u5361\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "IS_NEGATIVE_NUMBER":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u91d1\u989d\u4e0d\u80fd\u4e3a\u8d1f\u6570\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "IS_ZERO":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u91d1\u989d\u4e0d\u80fd\u4e3a\u96f6\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "OUT_LESSMONEY":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u4f4e\u4e8e\u5361\u7c7b\u6700\u5c0f\u4f59\u989d\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "OUT_MAXMONEY":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8d85\u51fa\u5361\u7c7b\u6700\u5927\u4f59\u989d\x3c/li\x3e\x3c/ul\x3e'),a=!1}}});return a}function get_sys_card_no(){var b=!1;$.ajax({type:"POST",url:"/ipos/get_sys_card_no/",data:"",dataType:"json",cache:!1,async:!1,success:function(a){switch(a.ret){case "OK":$("#id_sys_card_no").val(a.message);b=!0;break;case "FAIL":b=!1}}});return b}function funSaveAddCardBakData(b){var a=!1;b=b?b.formSerialize():$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/save_add_card_bak_data/",data:b,dataType:"json",cache:!1,async:!1,success:function(b){switch(b.ret){case "OK":$("#id_sys_card_no").val(b.message);a=!0;break;case "FAIL":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5236\u5361\u5931\u8d25\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_LOST":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u5361\u53f7\u5df2\u7ecf\u6302\u5931\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "CARD_STOP":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u5361\u53f7\u5df2\u7ecf\u505c\u7528\uff0c\u8bf7\u5148\u505a\u65e0\u5361\u9000\u5361\u64cd\u4f5c\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "HAVECARD":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8be5\u4eba\u5458\u5df2\u6709\u6b63\u5728\u4f7f\u7528\u7684\u5361\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "EMPNOTCARD":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u5361\u53f7\u5df2\u767b\u8bb0\u4eba\u5458\u8ddf\u5b9e\u9645\u53d1\u5361\u4eba\u5458\u4e0d\u4e00\u81f4\uff0c\u8bf7\u6838\u5bf9\u540e\u518d\u53d1\u5361\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "ISUSE":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u5361\u53f7\u5df2\u88ab\u4f7f\u7528\uff0c\u5982\u9700\u7ee7\u7eed\u4f7f\u7528\u8be5\u5361\uff0c\u8bf7\u5148\u9000\u5361\uff01\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "OUT_LESSMONEY":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u4f4e\u4e8e\u5361\u7c7b\u6700\u5c0f\u4f59\u989d\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "OUT_MAXMONEY":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u8d85\u51fa\u5361\u7c7b\u6700\u5927\u4f59\u989d\x3c/li\x3e\x3c/ul\x3e');a=!1;break;case "SYS_ISUSE":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5361\u8d26\u53f7\u5df2\u4f7f\u7528\uff0c\u8bf7\u5237\u65b0\u5f53\u524d\u9875\u9762\uff01\x3c/li\x3e\x3c/ul\x3e'),a=!1}}});return a}function funSaveIssuecardData(b){var a=!1;b=b?b.formSerialize():$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/save_issuecard_data/",data:b,dataType:"json",cache:!1,async:!1,success:function(b){switch(b.ret){case "OK":a=!0;break;case "FAIL":a=!1}}});return a}function funSaveCardManage(){var b="",a=$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/save_card_manage/",data:a,dataType:"json",cache:!1,async:!1,success:function(a){switch(a.ret){case "OK":b="OK";break;case "FAIL":b="FAIL";break;case "ISUSE":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5f53\u524d\u5361\u53f7\u5df2\u88ab\u4f7f\u7528\uff0c\u5982\u9700\u4f7f\u7528\u8be5\u5361,\u8bf7\u5148\u9000\u5361\uff01\x3c/li\x3e\x3c/ul\x3e');b="ISUSE";break;case "SYS_ISUSE":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u5361\u8d26\u53f7\u5df2\u4f7f\u7528,\u8bf7\u5237\u65b0\u5f53\u524d\u9875\u9762\uff01\x3c/li\x3e\x3c/ul\x3e'),b="SYS_ISUSE"}}});return b}function from_close(){$("#id_datalist").get(0).g.load_data();$("#Cancel").click()}function funChangeCardInfo(){var b=!1,a=$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/change_card_info/",data:a,dataType:"json",cache:!1,async:!1,success:function(a){switch(a.ret){case "OK":b=!0;break;case "FAIL":b=!1}}});return b}function funSaveData(b){var a=!1;b=b?b.formSerialize():$("#id_edit_form_consume").formSerialize();$.ajax({type:"POST",url:"/ipos/save_operate_data/",data:b,dataType:"json",cache:!1,async:!1,success:function(b){switch(b.ret){case "OK":a=!0;break;case "FAIL":$("#id_error").html('\x3cul class\x3d"errorlist"\x3e\x3cli\x3e\u7cfb\u7edf\u51fa\u9519\uff0c\u64cd\u4f5c\u5931\u8d25\uff01\x3c/li\x3e\x3c/ul\x3e'),a=!1}}});return a}$.validator.addMethod("isMoney",function(b,a){var c=/^(([1-9]\d*)|0)(\.\d{1,2})?$/;$("#"+a.id).bind("keyup",function(){this.value=this.value.replace(/[^\d.]/g,"");this.value=this.value.replace(/^\./g,"");this.value=this.value.replace(/\.{2,}/g,".");this.value=this.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".")});return this.optional(a)||c.exec(b)},$.validator.format("\u9519\u8bef"));