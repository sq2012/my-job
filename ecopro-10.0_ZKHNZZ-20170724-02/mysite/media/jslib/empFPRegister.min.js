/**
 * Created by Arvin on 2015-05-20.
 */
//绘画双手的起点横坐标
var x=28,y=346,fingerList=[],lastFPIdNum=null,globalContext=null,fingerBorderColor="rgb(71,75,79)",bgColor="rgb(243, 245,240)",strokeStyle="stroke",fillStyle="fill",fillFingerColor="rgb(71,75,79)",fpModifyFlag=!1;try{CanvasRenderingContext2D.prototype.oval=function(a,c,b,d){b=b/.75/2;d/=2;this.strokeStyle=bgColor;this.beginPath();this.moveTo(a,c-d);this.bezierCurveTo(a+b,c-d,a+b,c+d,a,c+d);this.bezierCurveTo(a-b,c+d,a-b,c-d,a,c-d);this.closePath();this.stroke();return this}}catch(a){}function drawFingerAndHand(a,c,b,d,e,f){c=initCoordArray(c,d,e,f);10>f?(c=new renderFinger(a,c),c.drawFinger(strokeStyle,b),renderInit(a,f,"html5"),fingerList.push(c)):12>f&&(new renderHand(a,c)).drawHand(b);showImage(a,"/media/img/base_fpVerify_clearImage.png","clearForRegister")}function clearImageData(){clearFPImage(globalContext,"register")}function checkCollCount(){var a="",c=null;getFPImage(function(b){var d=0;c=b.ret;0==c&&(d=b.data.enroll_index,a=b.data.jpg_base64);if(3!=d){if(1==d||2==d)collectTips(globalContext,tip3+":"+(FINGERPRINT_NUMBER-d),"html5"),drawProgressBar(globalContext,d),showImage(globalContext,a,"html5"),setTimeout(function(){clearImageData()},1E3);timer=setTimeout(function(){checkCollCount()},1E3)}else return showImage(globalContext,a,"html5"),setTimeout(function(){clearImageData()},1E3),drawProgressBar(globalContext,d),getFPTemplate("register")||drawProgressBar(globalContext,0),duressFingerFlag&&$("#duressFinger").attr("checked",!1),$("#duressFinger").attr("disabled",!1),$("#submitButtonId").attr("disabled",!1),collectFlag=!1,fpIdNum=-1,d})}function beginFPRegister(){var a={};a.url="/beginCapture?type\x3d1\x26random\x3d"+getRandomNum();a.async=!0;a.callback=function(a){a=a.ret;0==a?checkCollCount():-2001==a?collectTips(globalContext,tip2,"html5"):-2002==a?getWebServerInfo(null,"1"):-2005==a&&(cancelFPRegister(),renderAfterColl(globalContext,fpIdNum,bgColor,!1),collectTips(globalContext,tip1,"html5"))};excute(a)}function cancelFPRegister(){if(collectFlag){var a={};a.url="/cancelCapture?random\x3d"+getRandomNum();a.async=!1;clearTimeout(timer);a.callback=function(){duressFingerFlag&&$("#duressFinger").attr("checked",!1);fpModifyFlag&&$("#submitButtonId").attr("disabled",!1);$("#duressFinger").attr("disabled",!1);null!=fpIdNum&&renderAfterColl(globalContext,lastFPIdNum,bgColor,!1);collectFlag=!1};excute(a)}}function fpComparision(a,c){var b="",d=c.toString();a=encodeContent(a);d=encodeContent(d);$.ajax({type:"POST",url:"/iclock/att/finger_matching/",data:"template10\x3d"+a+"\x26templates\x3d"+d+"\x26checkObj\x3demp",dataType:"json",async:!1,success:function(a){"ok"==a.ret&&(b="ok");"noFingerServer"==a.msg&&(b="noFingerServer");"dllNotExist"==a.msg&&(b="dllNotExist");"noLicences"==a.msg&&(b="noLicences")},error:function(a,b,c){}});return b}function getDLLConnectCallBack(a){if(null==globalContext){var c=document.getElementById("canvas");globalContext=getCanvasContext(c)}0==a.ret?collectTips(globalContext,gettext("\u8fde\u63a5\u6307\u7eb9\u91c7\u96c6\u5668\u5931\u8d25"),"html5"):collectTips(globalContext,gettext("\u52a0\u8f7dZKFinger10\u5931\u8d25"),"html5")}function redraw(a,c){var b=document.getElementById("canvas");if(b=getCanvasContext(b)){for(var d=!1,e=0;e<fingerList.length;e++){var f=fingerList[e];f.drawFinger(strokeStyle,fingerBorderColor);if(b.isPointInPath(a,c)){d=!0;break}}e=0;a:for(;e<fingerList.length;e++)if(collectFlag&&fpIdNum==e&&renderAfterColl(globalContext,fpIdNum,bgColor,!1),f=fingerList[e],f.drawFinger(strokeStyle,fingerBorderColor),b.isPointInPath(a,c)){globalContext=b;f=!1;fpIdNum==e&&collectFlag&&(f=!0);var g;g=isContains(fingerIdArray,e);fpIdNum=e;g||(lastFPIdNum=fpIdNum);if(g){cancelFPRegister();confirm(tip5)?delFPData(!0,b,"html5"):delFPData(!1,b,"html5");break a}else f?(cancelFPRegister(),collectTips(globalContext,tip1,"html5"),drawProgressBar(b,0),fpIdNum=-1):(cancelFPRegister(),b.fillStyle=fillFingerColor,b.fill(),collectFlag=!0,$("#duressFinger").attr("disabled",!0),$("#submitButtonId").attr("disabled",!0),f=tip3+":"+FINGERPRINT_NUMBER,drawProgressBar(globalContext,0),collectTips(globalContext,f,"html5"),beginFPRegister())}else b.fillStyle=bgColor,b.fill(),renderInit(b,e,"html5"),collectFlag&&fpIdNum==e&&!d&&(b.fillStyle="yellow",b.fill())}}function draw(a,c){0<fingerList.length&&(fingerList=[]);for(var b=[],d=initCoordJson(),e=0;e<d.length;e++)drawFingerAndHand(a,b,c,d[e].coord.x,d[e].coord.y,e),b=[];checkFPReader(a,"html5");drawProgressBar(a,0);$("#submitButtonId").attr("disabled",!0)}function paramInit(){1==$("#id_forceavalidflag").val()&&(duressFingerShowFlag=!0);duressFingerShowFlag||$("#duressFingerDiv").hide();var a=$("#id_tfids10").val();""!=$.trim(a)&&(fingerIdDBArray=a.split(","));a=$("#id_fpcode").val();if(""!=$.trim(a))for(var a=a.split(","),c=0;c<a.length;c++)3==parseInt(a[c])&&duressFingerIdDBArray.push(fingerIdDBArray[c])}function pageInit(){paramInit();var a=document.getElementById("canvas"),c=getCanvasContext(a);fpIdNum=null;getDataFromPage();draw(c,fingerBorderColor);jQuery.support.cors=!0;a.onmousedown=function(b){b=b||window.event;if(b.which&&1==b.which){var c=a.getBoundingClientRect(),e=b.clientX-c.left;b=b.clientY-c.top;duressFingerFlag=$("#duressFinger").attr("checked");redraw(e,b)}else b.button&&1==b.button&&(c=a.getBoundingClientRect(),e=b.clientX-c.left,b=b.clientY-c.top,duressFingerFlag=$("#duressFinger").attr("checked"),redraw(e,b))}}function showFPRegister(){var a=document.createElement("div"),c=document.createElement("canvas");$(c).attr("id","canvas");$(c).attr("style","background:rgb(243, 245,240)");c.height=450;c.width=450;$(a).append(c);c='\x3cdiv id\x3d"duressFingerDiv" style\x3d"position: absolute; left: 310px; top: 300px; width: 140px; height: 28px; diaplay: block;"\x3e  \x3cinput type\x3d"checkbox" id\x3d"duressFinger" name\x3d"checkboxName"\x3e\x26nbsp;      \x3cspan style\x3d"font-size: 11px;"\x3e'+gettext("\u80c1\u8feb\u6307\u7eb9")+"\x3c/span\x3e\x3c/input\x3e\x3c/div\x3e";$(a).append(c);$(a).dialog({width:470,height:560,title:gettext("\u6307\u7eb9\u767b\u8bb0"),close:function(){$(this).dialog("destroy")},buttons:[{id:"submitButtonId",text:gettext("\u786e\u5b9a"),click:function(){submitEvent();$(this).dialog("destroy")}},{id:"closeButton",text:gettext("\u53d6\u6d88"),click:function(){$(this).dialog("destroy")}}]})}function submitEvent(){saveFPData(!0)}function cancelEvent(){fpModifyFlag?saveFPData(!1):(collectFlag&&(cancelFPRegister(),clearTimeout(timer)),closeWindow())}function showRegister(){canConnection=!0;$("#id_fp_register").addClass("linkStyle");$("#id_fp_register").removeAttr("style");$("#id_fp_register").removeAttr("title")}function submitRegister(){if(!canConnection)return alert(gettext("\u8bf7\u5b89\u88c5\u6307\u7eb9\u9a71\u52a8\u6216\u542f\u52a8\u8be5\u670d\u52a1!")),!1;showFPRegister();pageInit()}$(function(){$("#id_fp_help a").attr("href","/data/system/help/?p\x3d/file/"+$("#id_lng").val()+"/help/fingerprintDriverInstall.html");checkDriver(!1)});